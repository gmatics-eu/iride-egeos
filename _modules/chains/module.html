

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>chains.module &#8212; chains 1.0.dev0 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=5b4479735964841361fd" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=5b4479735964841361fd" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/rtd_sphinx_search.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=5b4479735964841361fd" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd" />
  <script src="../../_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=5b4479735964841361fd"></script>

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script src="../../_static/js/rtd_search_config.js"></script>
    <script src="../../_static/js/rtd_sphinx_search.min.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/chains/module';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
  
    <p class="title logo__title">chains 1.0.dev0 documentation</p>
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../packages/modules.html">API Reference</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../packages/chains.html">chains package</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../packages/chains.foresthealth.html">chains.foresthealth module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../packages/chains.module.html">chains.module module</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../py-modindex.html">Module Index</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../genindex.html">Index</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">



<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>

</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1></h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <h1>Source code for chains.module</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">configparser</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>

<span class="kn">import</span> <span class="nn">dask.array</span> <span class="k">as</span> <span class="nn">da</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">planetary_computer</span>
<span class="kn">import</span> <span class="nn">pystac_client</span>
<span class="kn">import</span> <span class="nn">rasterio</span>
<span class="kn">import</span> <span class="nn">rioxarray</span> <span class="k">as</span> <span class="nn">rio</span>
<span class="kn">import</span> <span class="nn">stackstac</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">from</span> <span class="nn">pystac_client.stac_api_io</span> <span class="kn">import</span> <span class="n">StacApiIO</span>
<span class="kn">from</span> <span class="nn">rasterio.features</span> <span class="kn">import</span> <span class="n">rasterize</span>
<span class="kn">from</span> <span class="nn">retry</span> <span class="kn">import</span> <span class="n">retry</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">ndimage</span>
<span class="kn">from</span> <span class="nn">scipy.ndimage</span> <span class="kn">import</span> <span class="n">binary_dilation</span>
<span class="kn">from</span> <span class="nn">urllib3</span> <span class="kn">import</span> <span class="n">Retry</span>


<div class="viewcode-block" id="initialize_logger"><a class="viewcode-back" href="../../packages/chains.module.html#chains.module.initialize_logger">[docs]</a><span class="k">def</span> <span class="nf">initialize_logger</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;my-logger&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initializes a logger with the given name. If no name is provided, it default to &#39;my-logger&#39;.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    - name (str): Optional. The name of the logger [default: &quot;my-logger&quot;].</span>

<span class="sd">    Returns:</span>
<span class="sd">    - logger (logger): The initialized logger.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">()</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="c1"># Extract chain, assessment_kind and aoi from config_dict</span>
    <span class="n">config_dict</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">(</span><span class="n">config_file</span><span class="o">=</span><span class="s2">&quot;config.ini&quot;</span><span class="p">)</span>
    <span class="n">chain</span> <span class="o">=</span> <span class="n">config_dict</span><span class="p">[</span><span class="s2">&quot;chain&quot;</span><span class="p">]</span>
    <span class="n">assessment_kind</span> <span class="o">=</span> <span class="n">config_dict</span><span class="p">[</span><span class="s2">&quot;assessment_kind&quot;</span><span class="p">]</span>
    <span class="n">aoi</span> <span class="o">=</span> <span class="n">config_dict</span><span class="p">[</span><span class="s2">&quot;aoi&quot;</span><span class="p">]</span>

    <span class="c1"># use current time for log file name, along with chain, assessment_kind and aoi</span>
    <span class="n">now_str</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">%H%M%S&quot;</span><span class="p">)</span>
    <span class="n">log_file_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">aoi</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">chain</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">assessment_kind</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">now_str</span><span class="si">}</span><span class="s2">.log&quot;</span>

    <span class="n">log_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">)</span>
    <span class="n">log_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">log_dir</span><span class="p">,</span> <span class="n">log_file_name</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">log_dir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">log_dir</span><span class="p">)</span>

    <span class="n">handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="n">log_file</span><span class="p">)</span>

    <span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span>
        <span class="s2">&quot;</span><span class="si">%(asctime)s</span><span class="s2"> - </span><span class="si">%(name)s</span><span class="s2"> - </span><span class="si">%(levelname)s</span><span class="s2"> - </span><span class="si">%(message)s</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="n">handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">logger</span></div>


<div class="viewcode-block" id="timed"><a class="viewcode-back" href="../../packages/chains.module.html#chains.module.timed">[docs]</a><span class="k">def</span> <span class="nf">timed</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This decorator prints the execution time for the decorated function.&quot;&quot;&quot;</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;my-logger&quot;</span><span class="p">)</span>

    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> ran in </span><span class="si">{}</span><span class="s2">s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">return</span> <span class="n">wrapper</span></div>


<div class="viewcode-block" id="stac_to_dataset"><a class="viewcode-back" href="../../packages/chains.module.html#chains.module.stac_to_dataset">[docs]</a><span class="k">def</span> <span class="nf">stac_to_dataset</span><span class="p">(</span>
    <span class="n">aoi</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="n">time_range</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span>
    <span class="n">collections</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
    <span class="n">query</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="n">assets</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
    <span class="n">epsg</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">resolution</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">nodata</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform a SpatioTemporal Asset Catalog (STAC) query and return the results as an Xarray Dataset.</span>

<span class="sd">    This function queries a STAC catalog for geospatial data that falls within a specified area of interest and time range,</span>
<span class="sd">    applies additional filters using a JSON query, and then assembles the results into an Xarray Dataset.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    ----------</span>
<span class="sd">    aoi : dictionary</span>
<span class="sd">        A dictionary representing the area of interest in WGS84 coordinates.</span>

<span class="sd">    time_range : tuple</span>
<span class="sd">        A tuple (start_time, end_time) representing the temporal range for the query.</span>

<span class="sd">    collections : list of str</span>
<span class="sd">        A list of STAC collection IDs to filter the search.</span>

<span class="sd">    query : dict</span>
<span class="sd">        A JSON-like dictionary that specifies additional filters for the query.</span>

<span class="sd">    assets : list of str</span>
<span class="sd">        A list of asset names to include in the output dataset.</span>

<span class="sd">    epsg : int</span>
<span class="sd">        The EPSG code specifying the coordinate reference system (CRS) for the output dataset.</span>

<span class="sd">    resolution : float</span>
<span class="sd">        The spatial resolution in the units of the specified CRS (epsg).</span>

<span class="sd">    nodata : float, optional</span>
<span class="sd">        The value to be used for nodata or missing data. Default is np.nan.</span>

<span class="sd">    Returns:</span>
<span class="sd">    -------</span>
<span class="sd">    xarray.Dataset</span>
<span class="sd">        An Xarray Dataset containing geospatial data from the STAC catalog.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">retry</span> <span class="o">=</span> <span class="n">Retry</span><span class="p">(</span>
        <span class="n">total</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">backoff_factor</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">status_forcelist</span><span class="o">=</span><span class="p">[</span><span class="mi">404</span><span class="p">,</span> <span class="mi">502</span><span class="p">,</span> <span class="mi">503</span><span class="p">,</span> <span class="mi">504</span><span class="p">],</span>
        <span class="n">allowed_methods</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">stac_api_io</span> <span class="o">=</span> <span class="n">StacApiIO</span><span class="p">(</span><span class="n">max_retries</span><span class="o">=</span><span class="n">retry</span><span class="p">)</span>

    <span class="n">stac</span> <span class="o">=</span> <span class="n">pystac_client</span><span class="o">.</span><span class="n">Client</span><span class="o">.</span><span class="n">open</span><span class="p">(</span>
        <span class="s2">&quot;https://planetarycomputer.microsoft.com/api/stac/v1&quot;</span><span class="p">,</span>
        <span class="n">modifier</span><span class="o">=</span><span class="n">planetary_computer</span><span class="o">.</span><span class="n">sign_inplace</span><span class="p">,</span>
        <span class="n">stac_io</span><span class="o">=</span><span class="n">stac_api_io</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">search</span> <span class="o">=</span> <span class="n">stac</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
        <span class="n">intersects</span><span class="o">=</span><span class="n">aoi</span><span class="p">,</span>
        <span class="n">datetime</span><span class="o">=</span><span class="n">time_range</span><span class="p">,</span>
        <span class="n">collections</span><span class="o">=</span><span class="n">collections</span><span class="p">,</span>
        <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">items</span> <span class="o">=</span> <span class="n">search</span><span class="o">.</span><span class="n">item_collection</span><span class="p">()</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">stackstac</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>
        <span class="n">items</span><span class="p">,</span>
        <span class="n">assets</span><span class="o">=</span><span class="n">assets</span><span class="p">,</span>
        <span class="n">epsg</span><span class="o">=</span><span class="n">epsg</span><span class="p">,</span>
        <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">!=</span> <span class="n">nodata</span><span class="p">,</span> <span class="n">other</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="p">)</span>  <span class="c1"># sentinel-2 uses 0 as nodata</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">to_dataset</span><span class="p">(</span><span class="s2">&quot;band&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ds</span></div>


<div class="viewcode-block" id="dilate_each_matrix"><a class="viewcode-back" href="../../packages/chains.module.html#chains.module.dilate_each_matrix">[docs]</a><span class="k">def</span> <span class="nf">dilate_each_matrix</span><span class="p">(</span><span class="n">mask_np</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">structure</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Applies binary dilation to each matrix in a 3D array, iterating over axis 0.</span>
<span class="sd">    In this case, False values (considered cloudy) will be dilated.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        mask_np (numpy.ndarray): 3D array</span>
<span class="sd">        iterations (int): Number of dilation iterations for each matrix.</span>
<span class="sd">        structure (numpy.ndarray): Structuring element for dilation. If None, full connectivity is used.</span>

<span class="sd">    Returns:</span>
<span class="sd">        numpy.ndarray: 3D array with dilation applied to each matrix, with False dilated.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Allocate array for dilated result</span>
    <span class="n">dilated_mask_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">mask_np</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mask_np</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="c1"># Invert the mask before dilation: True becomes False and vice versa</span>
        <span class="n">inverted_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">mask_np</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="c1"># Apply binary dilation to the inverted mask</span>
        <span class="n">dilated_inverted_mask</span> <span class="o">=</span> <span class="n">binary_dilation</span><span class="p">(</span>
            <span class="n">inverted_mask</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="n">iterations</span><span class="p">,</span> <span class="n">structure</span><span class="o">=</span><span class="n">structure</span>
        <span class="p">)</span>

        <span class="c1"># Invert the mask again after dilation</span>
        <span class="n">dilated_mask_np</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">dilated_inverted_mask</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">dilated_mask_np</span></div>


<div class="viewcode-block" id="s2l2a_cloudmask"><a class="viewcode-back" href="../../packages/chains.module.html#chains.module.s2l2a_cloudmask">[docs]</a><span class="k">def</span> <span class="nf">s2l2a_cloudmask</span><span class="p">(</span>
    <span class="n">ds</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">da_qa</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">,</span> <span class="n">dilation_iter</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">13</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Applies cloud masking to a given xarray Dataset containing</span>
<span class="sd">    Sentinel-2 L2A data based on the quality band. It also applies</span>
<span class="sd">    dilation to the cloud mask to expand cloud coverage and include</span>
<span class="sd">    cloud edges and potentially cloud shadows.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        ds (xarray.Dataset): Input Dataset to be cloud-masked.</span>
<span class="sd">        da_qa (xarray.DataArray): Quality band DataArray containing information about cloud presence.</span>
<span class="sd">        dilation_iter (int): Number of dilation iterations to perform, default is 13.</span>

<span class="sd">    Returns:</span>
<span class="sd">        xarray.Dataset: Cloud-masked Dataset with dilated cloud masks.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Define values in the QA band that indicate cloud and water-related information</span>
    <span class="c1"># on cloud shadows, clouds, cirrus</span>
    <span class="n">mask_values</span> <span class="o">=</span> <span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>  <span class="c1"># 3</span>

    <span class="n">mask</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Initialize mask as True (all pixels initially unmasked)</span>
    <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">mask_values</span><span class="p">:</span>
        <span class="c1"># Update mask: Multiply mask with False (0) where pixels have cloud-related values</span>
        <span class="n">mask</span> <span class="o">*=</span> <span class="n">da_qa</span> <span class="o">!=</span> <span class="n">value</span>
    <span class="c1"># Convert the cloud mask to a binary numpy array for dilation</span>
    <span class="n">mask_np</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">values</span>

    <span class="c1"># Perform binary dilation on the cloud mask</span>
    <span class="n">dilated_mask_np</span> <span class="o">=</span> <span class="n">dilate_each_matrix</span><span class="p">(</span><span class="n">mask_np</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="n">dilation_iter</span><span class="p">)</span>

    <span class="c1"># Convert the dilated numpy array back to a DataArray with the same dimensions as the original mask</span>
    <span class="n">dilated_mask</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">dilated_mask_np</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">da_qa</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="n">da_qa</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>

    <span class="c1"># Mask the original Dataset using the dilated cloud mask</span>
    <span class="n">ds_masked</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dilated_mask</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ds_masked</span></div>


<div class="viewcode-block" id="s2l2a_edgemask"><a class="viewcode-back" href="../../packages/chains.module.html#chains.module.s2l2a_edgemask">[docs]</a><span class="k">def</span> <span class="nf">s2l2a_edgemask</span><span class="p">(</span><span class="n">ds</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Applies masking to a given xarray Dataset containing</span>
<span class="sd">    Sentinel-2 L2A data based on the valid values contained in</span>
<span class="sd">    the B8A and B09 bands.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        ds (xarray.Dataset): Input Dataset to be masked.</span>

<span class="sd">    Returns:</span>
<span class="sd">        xarray.Dataset: Masked Dataset.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># select the B8A and B9 bands and apply the mask</span>
    <span class="n">b8a_band</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;B8A&quot;</span><span class="p">]</span>
    <span class="n">b9_band</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;B09&quot;</span><span class="p">]</span>

    <span class="c1"># create a mask where either of the selected bands has valid data</span>
    <span class="n">combined_mask</span> <span class="o">=</span> <span class="n">b8a_band</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">b9_band</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span>

    <span class="c1"># Apply the mask to the original dataset</span>
    <span class="n">ds_masked</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">combined_mask</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ds_masked</span></div>


<div class="viewcode-block" id="s2l2a_snowmask"><a class="viewcode-back" href="../../packages/chains.module.html#chains.module.s2l2a_snowmask">[docs]</a><span class="k">def</span> <span class="nf">s2l2a_snowmask</span><span class="p">(</span><span class="n">ds</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">band_green</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">band_swir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Applies snow masking to a given xarray Dataset containing</span>
<span class="sd">    Sentinel-2 L2A data based on the NDSI values.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        ds (xarray.Dataset): Input Dataset to be cloud-masked.</span>
<span class="sd">        band_green (string): name of the green band</span>
<span class="sd">        band_swir (string): name of the SWIR band</span>

<span class="sd">    Returns:</span>
<span class="sd">        xarray.Dataset: Snow-masked Dataset.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ndsi_threshold</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="n">ndsi</span> <span class="o">=</span> <span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="n">band_green</span><span class="p">]</span> <span class="o">-</span> <span class="n">ds</span><span class="p">[</span><span class="n">band_swir</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="n">band_green</span><span class="p">]</span> <span class="o">+</span> <span class="n">ds</span><span class="p">[</span><span class="n">band_swir</span><span class="p">])</span>
    <span class="n">not_snow</span> <span class="o">=</span> <span class="n">ndsi</span> <span class="o">&lt;</span> <span class="n">ndsi_threshold</span>

    <span class="c1"># Mask the original Dataset using the snow mask</span>
    <span class="n">ds_masked</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">not_snow</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ds_masked</span></div>


<div class="viewcode-block" id="s2l2a_masked"><a class="viewcode-back" href="../../packages/chains.module.html#chains.module.s2l2a_masked">[docs]</a><span class="k">def</span> <span class="nf">s2l2a_masked</span><span class="p">(</span><span class="n">ds</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Applies masking to the given Sentinel-2 Level-2A dataset.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        ds (xr.Dataset): The Sentinel-2 Level-2A dataset to be masked.</span>

<span class="sd">    Returns:</span>
<span class="sd">        xr.Dataset: The masked Sentinel-2 Level-2A dataset.</span>

<span class="sd">    Example Usage:</span>
<span class="sd">        import xarray as xr</span>

<span class="sd">        # Load Sentinel-2 Level-2A dataset using xarray</span>
<span class="sd">        ds = xr.open_dataset(&#39;path/to/dataset.nc&#39;)</span>

<span class="sd">        # Apply masking</span>
<span class="sd">        ds_masked = s2l2a_masked(ds)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">da_qa</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;SCL&quot;</span><span class="p">]</span>
    <span class="c1"># Apply existing masks</span>
    <span class="n">ds_masked</span> <span class="o">=</span> <span class="n">s2l2a_cloudmask</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">da_qa</span><span class="p">)</span>
    <span class="n">ds_masked</span> <span class="o">=</span> <span class="n">s2l2a_edgemask</span><span class="p">(</span><span class="n">ds_masked</span><span class="p">)</span>
    <span class="n">band_green</span> <span class="o">=</span> <span class="s2">&quot;B03&quot;</span>
    <span class="n">band_swir</span> <span class="o">=</span> <span class="s2">&quot;B11&quot;</span>
    <span class="n">ds_masked</span> <span class="o">=</span> <span class="n">s2l2a_snowmask</span><span class="p">(</span><span class="n">ds_masked</span><span class="p">,</span> <span class="n">band_green</span><span class="p">,</span> <span class="n">band_swir</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ds_masked</span></div>


<div class="viewcode-block" id="harmonize_to_old"><a class="viewcode-back" href="../../packages/chains.module.html#chains.module.harmonize_to_old">[docs]</a><span class="k">def</span> <span class="nf">harmonize_to_old</span><span class="p">(</span><span class="n">ds</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Harmonizes new Sentinel-2 data to the old baseline. This function take as input a Xarray Dataset containing</span>
<span class="sd">    both images with old (03.00) and new (04.00) processing baselines.</span>

<span class="sd">    Parameters</span>
<span class="sd">        ds (xarray.Dataset): A Dataset with four dimensions: time, band, y, x</span>

<span class="sd">    Returns</span>
<span class="sd">        xarray.Dataset: A Dataset with all values harmonized to the old processing baseline.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cutoff</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2022</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>

    <span class="n">offset</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="n">bands</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;B01&quot;</span><span class="p">,</span>
        <span class="s2">&quot;B02&quot;</span><span class="p">,</span>
        <span class="s2">&quot;B03&quot;</span><span class="p">,</span>
        <span class="s2">&quot;B04&quot;</span><span class="p">,</span>
        <span class="s2">&quot;B05&quot;</span><span class="p">,</span>
        <span class="s2">&quot;B06&quot;</span><span class="p">,</span>
        <span class="s2">&quot;B07&quot;</span><span class="p">,</span>
        <span class="s2">&quot;B08&quot;</span><span class="p">,</span>
        <span class="s2">&quot;B8A&quot;</span><span class="p">,</span>
        <span class="s2">&quot;B09&quot;</span><span class="p">,</span>
        <span class="s2">&quot;B10&quot;</span><span class="p">,</span>
        <span class="s2">&quot;B11&quot;</span><span class="p">,</span>
        <span class="s2">&quot;B12&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">dataset_bands</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">data_vars</span><span class="p">)</span>

    <span class="n">old</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">cutoff</span><span class="p">))</span>

    <span class="n">to_process</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">bands</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">dataset_bands</span><span class="p">))</span>
    <span class="n">not_to_process</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">dataset_bands</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">to_process</span><span class="p">))</span>
    <span class="n">new</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">cutoff</span><span class="p">,</span> <span class="kc">None</span><span class="p">))[</span><span class="n">not_to_process</span><span class="p">]</span>  <span class="c1"># .drop_sel(band=to_process)</span>

    <span class="n">new_harmonized</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">cutoff</span><span class="p">,</span> <span class="kc">None</span><span class="p">))[</span><span class="n">to_process</span><span class="p">]</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
    <span class="n">new_harmonized</span> <span class="o">-=</span> <span class="n">offset</span>

    <span class="n">new</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">merge</span><span class="p">([</span><span class="n">new</span><span class="p">,</span> <span class="n">new_harmonized</span><span class="p">])[</span>
        <span class="n">dataset_bands</span>
    <span class="p">]</span>  <span class="c1"># .sel(band=ds.band.data.tolist())</span>
    <span class="k">return</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="coords_to_attrs"><a class="viewcode-back" href="../../packages/chains.module.html#chains.module.coords_to_attrs">[docs]</a><span class="k">def</span> <span class="nf">coords_to_attrs</span><span class="p">(</span><span class="n">ds</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">excluded</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[])</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a Xarray Dataset, converts its non-dimension coordinates to attributes and drops these coordinates.</span>
<span class="sd">    Any additional coordinates which should not be converted and dropped can be specified in the &#39;excluded&#39; list.</span>

<span class="sd">    Args:</span>
<span class="sd">        ds (xarray.Dataset): The Dataset to process.</span>
<span class="sd">        excluded (list): The list of additional excluded coordinates.</span>

<span class="sd">    Returns:</span>
<span class="sd">        xarray.Dataset: The processed Dataset.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">coord</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">excluded</span><span class="p">:</span>
            <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">coord</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">coord</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ds</span></div>


<div class="viewcode-block" id="isel_func"><a class="viewcode-back" href="../../packages/chains.module.html#chains.module.isel_func">[docs]</a><span class="k">def</span> <span class="nf">isel_func</span><span class="p">(</span><span class="n">ds</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">indexer</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a Xarray Dataset, applies the isel function by selecting time indexes contained in a Xarray DataArray and</span>
<span class="sd">    drops the time coordinate. This function is meant to be applied to a Dask chunk in the xarray.Dataset.map_blocks</span>
<span class="sd">    function.</span>

<span class="sd">    Args:</span>
<span class="sd">        ds (xarray.Dataset): The Dataset to apply the isel function to.</span>
<span class="sd">        indexer (xarray.DataArray): The DataArray containing the time indexes to select from ds.</span>

<span class="sd">    Returns:</span>
<span class="sd">        xarray.Dataset: The processed Dataset.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ds_sel</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">indexer</span><span class="p">)</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ds_sel</span></div>


<div class="viewcode-block" id="medoid_mosaic"><a class="viewcode-back" href="../../packages/chains.module.html#chains.module.medoid_mosaic">[docs]</a><span class="nd">@retry</span><span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="n">tries</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">medoid_mosaic</span><span class="p">(</span><span class="n">ds</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The method  apply a Medoid process for pixels with multiple observations acquired on different dates (Kennedy et al., 2018),</span>
<span class="sd">    whereby the spectral value for each band for each pixel was compared to the median value for the same pixel calculated from among values available</span>
<span class="sd">    or all images selected for that year.</span>
<span class="sd">    Then, the pixel whose spectral values are the most like the medians using Euclidean spectral distance was selected,</span>
<span class="sd">    and the relative band values were used to populate the image composite. This implementation expects as input Sentinel-2 L2A dataset.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        ds (xarray.Dataset): Input Sentinel-2 L2A Dataset.</span>

<span class="sd">    Returns:</span>
<span class="sd">        xarray.Dataset: Dataset containing the medoid composite.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># chunks the dataset along the x and y dimensions (time should remain unchunked)</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="mi">1024</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="mi">1024</span><span class="p">})</span>

    <span class="c1"># drops coordinates with no associated dimension</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">coords_to_attrs</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>

    <span class="c1"># time median</span>
    <span class="n">ds_median</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Euclidean distance between each observation and their median, summing among all bands.</span>
    <span class="c1"># da_dist is a DataArray with the same dimensions as ds and only one variable, the distance.</span>
    <span class="c1"># fillna is necessary because if there&#39;s a pixel with nan for all times, argmin can&#39;t choose one</span>
    <span class="c1"># of these and throws an error.</span>
    <span class="n">da_dist</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(((</span><span class="n">ds</span> <span class="o">-</span> <span class="n">ds_median</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span><span class="o">.</span><span class="n">to_array</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="s2">&quot;variable&quot;</span><span class="p">))</span>

    <span class="c1"># for each pixel, finds the time index with the smallest value (for the distance variable).</span>
    <span class="c1"># medoid_index is a DataArray with the same spatial dimensions as ds and only one variable, the time index</span>
    <span class="n">medoid_index</span> <span class="o">=</span> <span class="n">da_dist</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">medoid_index</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">ds</span><span class="o">.</span><span class="n">chunksizes</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">],</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">ds</span><span class="o">.</span><span class="n">chunksizes</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]})</span>

    <span class="c1"># to use map_blocks with a function that modifies the Dataset shape, you need to provide a template</span>
    <span class="c1"># dataset that has exactly the same shape as the output of map_blocks</span>
    <span class="n">ds_template</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>

    <span class="c1"># applies the isel function in a vectorized way</span>
    <span class="n">ds_medoid</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">map_blocks</span><span class="p">(</span><span class="n">isel_func</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">medoid_index</span><span class="p">],</span> <span class="n">template</span><span class="o">=</span><span class="n">ds_template</span><span class="p">)</span>

    <span class="c1"># counts the number of observations to measure the quality of the medoid and stores it in a new dataset variable</span>

    <span class="n">n_images</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;B02&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
    <span class="n">ds_medoid</span><span class="p">[</span><span class="s2">&quot;nImages&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_images</span>

    <span class="k">return</span> <span class="n">ds_medoid</span></div>


<div class="viewcode-block" id="datarray2dataset"><a class="viewcode-back" href="../../packages/chains.module.html#chains.module.datarray2dataset">[docs]</a><span class="k">def</span> <span class="nf">datarray2dataset</span><span class="p">(</span><span class="n">da</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert from DataArray to Dataset. If the &#39;long_name&#39; attribute is present and matches the number of bands,</span>
<span class="sd">    use it to rename the bands. Otherwise, convert without renaming and notify the user.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        da (xarray.DataArray): Input DataArray.</span>

<span class="sd">    Returns:</span>
<span class="sd">        xarray.Dataset: Dataset with variables, renamed if possible.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Convert to DataSet</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">to_dataset</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;band&quot;</span><span class="p">)</span>

    <span class="c1"># Check if &#39;long_name&#39; attribute exists and matches the number of bands</span>
    <span class="k">if</span> <span class="s2">&quot;long_name&quot;</span> <span class="ow">in</span> <span class="n">da</span><span class="o">.</span><span class="n">attrs</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">da</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;long_name&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="n">da</span><span class="o">.</span><span class="n">sizes</span><span class="p">[</span><span class="s2">&quot;band&quot;</span><span class="p">]:</span>
        <span class="n">variable_names</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;long_name&quot;</span><span class="p">]</span>
        <span class="n">name_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">name</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">variable_names</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">)}</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">name_dict</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;&#39;long_name&#39; attribute is not present or does not match the number of bands. Bands will not be renamed.&quot;</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">dataset</span></div>


<div class="viewcode-block" id="apply_fnf_mask"><a class="viewcode-back" href="../../packages/chains.module.html#chains.module.apply_fnf_mask">[docs]</a><span class="k">def</span> <span class="nf">apply_fnf_mask</span><span class="p">(</span>
    <span class="n">data_array</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">,</span> <span class="n">mask_tiff_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">epsg</span><span class="p">:</span> <span class="nb">int</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply a mask to an xarray.DataArray based on a external forest map (in GeoTIFF format).</span>
<span class="sd">    The forest mask must have:</span>
<span class="sd">    - 0 or nan in case of not forest type pixel</span>
<span class="sd">    - a number &gt;=1 for a forest type pixel.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        data_array (xarray.DataArray): The xarray.DataArray to be masked.</span>
<span class="sd">        mask_tiff_path (str): The file path to the  GeoTIFF defining the mask.</span>

<span class="sd">    Returns:</span>
<span class="sd">        xarray.DataArray: The xarray.DataArray with the mask applied.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Read the mask GeoTIFF using rioxarray</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">mask_tiff_path</span><span class="p">)</span>
    <span class="n">data_array</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">set_crs</span><span class="p">(</span><span class="s2">&quot;EPSG:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">epsg</span><span class="p">))</span>

    <span class="c1"># Reproject and align the mask_data_array to the same grid as data_array using &#39;nearest&#39; resampling</span>
    <span class="n">mask_repr_match</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">reproject_match</span><span class="p">(</span><span class="n">data_array</span><span class="p">)</span>

    <span class="n">mask_repr_match</span> <span class="o">=</span> <span class="n">mask_repr_match</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">data_array</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
            <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">data_array</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>

    <span class="c1"># Apply the mask</span>
    <span class="c1"># if the provided mask is non-binary (i.e. it&#39;s a forest category map), makes it binary by</span>
    <span class="c1"># putting zeroes where there are no forests and ones everywhere else</span>
    <span class="n">cond0</span> <span class="o">=</span> <span class="n">mask_repr_match</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="n">cond1</span> <span class="o">=</span> <span class="n">mask_repr_match</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="n">isbinary</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">cond0</span><span class="p">,</span> <span class="n">cond1</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">isbinary</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">mask_repr_match</span> <span class="o">=</span> <span class="n">mask_repr_match</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">mask_repr_match</span> <span class="o">=</span> <span class="n">mask_repr_match</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_repr_match</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">masked_data</span> <span class="o">=</span> <span class="n">data_array</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_repr_match</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">masked_data</span><span class="p">[</span><span class="s2">&quot;band_data&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s2">&quot;band&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="clip_raster_by_vector"><a class="viewcode-back" href="../../packages/chains.module.html#chains.module.clip_raster_by_vector">[docs]</a><span class="k">def</span> <span class="nf">clip_raster_by_vector</span><span class="p">(</span>
    <span class="n">data_array</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">,</span> <span class="n">vector</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Clip a DataArray based on the polygon defined by the vector and return a new DataArray.</span>
<span class="sd">    This method put no data value outside the vector border.</span>
<span class="sd">    Parameters:</span>
<span class="sd">        data_array (xarray.DataArray): The xarray.DataArray to be clipped.</span>
<span class="sd">        vector (xarray.DataArray): The xarray.DataArray defining the polygon for clipping.</span>

<span class="sd">    Returns:</span>
<span class="sd">        xarray.DataArray: The clipped DataArray.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">epsg</span> <span class="o">=</span> <span class="n">data_array</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span>
    <span class="c1"># Clip the input DataArray to the polygon defined by the vector</span>
    <span class="n">clipped_data_array</span> <span class="o">=</span> <span class="n">data_array</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">vector</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">epsg</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">clipped_data_array</span></div>


<div class="viewcode-block" id="rasterize_geodataframe"><a class="viewcode-back" href="../../packages/chains.module.html#chains.module.rasterize_geodataframe">[docs]</a><span class="k">def</span> <span class="nf">rasterize_geodataframe</span><span class="p">(</span><span class="n">gdf</span><span class="p">,</span> <span class="n">raster_template_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Rasterize a GeoDataFrame using a template raster.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    - gdf (GeoDataFrame): The GeoDataFrame to rasterize.</span>
<span class="sd">    - raster_template_path (str): The path to the template raster.</span>

<span class="sd">    Returns:</span>
<span class="sd">    - raster_xarray (xarray.DataArray): The rasterized data as a DataArray.</span>
<span class="sd">    - raster_meta (dict): The metadata of the resulting raster.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Read the template raster</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">raster_template_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="n">raster_meta</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Rasterize the GeoDataFrame</span>
        <span class="n">rasterized</span> <span class="o">=</span> <span class="n">rasterize</span><span class="p">(</span>
            <span class="p">[(</span><span class="n">geometry</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">geometry</span> <span class="ow">in</span> <span class="n">gdf</span><span class="o">.</span><span class="n">geometry</span><span class="p">],</span>
            <span class="n">out_shape</span><span class="o">=</span><span class="n">src</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
            <span class="n">transform</span><span class="o">=</span><span class="n">src</span><span class="o">.</span><span class="n">transform</span><span class="p">,</span>
            <span class="n">fill</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">all_touched</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;uint8&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">raster_meta</span><span class="p">[</span><span class="s2">&quot;dtype&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;uint8&quot;</span>

        <span class="n">raster_xarray</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
            <span class="n">rasterized</span><span class="p">,</span>
            <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">),</span>
            <span class="n">coords</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">raster_meta</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">]),</span>
                <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">raster_meta</span><span class="p">[</span><span class="s2">&quot;width&quot;</span><span class="p">]),</span>
            <span class="p">},</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">raster_xarray</span><span class="p">,</span> <span class="n">raster_meta</span></div>


<div class="viewcode-block" id="normalized_difference"><a class="viewcode-back" href="../../packages/chains.module.html#chains.module.normalized_difference">[docs]</a><span class="k">def</span> <span class="nf">normalized_difference</span><span class="p">(</span><span class="n">da_1</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">,</span> <span class="n">da_2</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given two Xarray DataArray representing two different bands of the same dataset,</span>
<span class="sd">    computes the normalized difference between the two bands.</span>
<span class="sd">    Parameters:</span>
<span class="sd">        da_1 (xarray.DataArray): First DataArray.</span>
<span class="sd">        da_2 (xarray.DataArray): Second DataArray.</span>

<span class="sd">    Returns:</span>
<span class="sd">        xarray.DataArray: DataArray containing the normalized difference.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">da_1</span> <span class="o">-</span> <span class="n">da_2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">da_1</span> <span class="o">+</span> <span class="n">da_2</span><span class="p">)</span></div>


<div class="viewcode-block" id="calculate_ndmi_nbr_msi"><a class="viewcode-back" href="../../packages/chains.module.html#chains.module.calculate_ndmi_nbr_msi">[docs]</a><span class="k">def</span> <span class="nf">calculate_ndmi_nbr_msi</span><span class="p">(</span><span class="n">ds</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a Xarray Dataset containing Sentinel-2 L2A data, computes the</span>
<span class="sd">    NDMI, NDR and MSI indexes.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        ds (xarray.Dataset): Input Dataset containing Sentinel-2 L2A data.</span>

<span class="sd">    Returns:</span>
<span class="sd">        ndmi (xarray.DataArray): DataArray containing the NDMI index.</span>
<span class="sd">        nbr (xarray.DataArray): DataArray containing the NBR index.</span>
<span class="sd">        msi (xarray.DataArray): DataArray containing the MSI index.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># convert xarray datarray to dataset</span>

    <span class="n">ndmi</span> <span class="o">=</span> <span class="n">normalized_difference</span><span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;B08&quot;</span><span class="p">],</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;B11&quot;</span><span class="p">])</span>
    <span class="n">nbr</span> <span class="o">=</span> <span class="n">normalized_difference</span><span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;B08&quot;</span><span class="p">],</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;B12&quot;</span><span class="p">])</span>
    <span class="n">msi</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;B11&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;B08&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">ndmi</span><span class="p">,</span> <span class="n">nbr</span><span class="p">,</span> <span class="n">msi</span></div>


<div class="viewcode-block" id="calculate_magnitude"><a class="viewcode-back" href="../../packages/chains.module.html#chains.module.calculate_magnitude">[docs]</a><span class="k">def</span> <span class="nf">calculate_magnitude</span><span class="p">(</span>
    <span class="n">ndmi_pre</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">,</span>
    <span class="n">nbr_pre</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">,</span>
    <span class="n">msi_pre</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">,</span>
    <span class="n">ndmi_post</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">,</span>
    <span class="n">nbr_post</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">,</span>
    <span class="n">msi_post</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given six Xarray DataArray containing the NDMI, NBR and MSI indexes over two</span>
<span class="sd">    concatenated periods of time, the method uses a particular implementation of the Three Indices Three Dimensions (3I3D)</span>
<span class="sd">    algorithm (Francini et a., 2022 - https://doi.org/10.3390/s22052015).</span>
<span class="sd">    In this method, the forest health decrease magnitude is calculated by averaging just those three PMIs and</span>
<span class="sd">    it has values between 0 and 1.</span>
<span class="sd">    Lastly, for storage purposes, so that images can be stored using byte datatype,</span>
<span class="sd">    the float values between 0 and 1 are multiplied by 255 (2^8)</span>

<span class="sd">    Parameters:</span>
<span class="sd">        ndmi_pre (xarray.DataArray): DataArray containing the NDMI index for the initial period of time.</span>
<span class="sd">        nbr_pre (xarray.DataArray): DataArray containing the NBR index for the initial period of time.</span>
<span class="sd">        msi_pre (xarray.DataArray): DataArray containing the MSI index for the initial period of time.</span>
<span class="sd">        ndmi_post (xarray.DataArray): DataArray containing the NDMI index for the final period of time.</span>
<span class="sd">        nbr_post (xarray.DataArray): DataArray containing the NBR index for the final period of time.</span>
<span class="sd">        msi_post (xarray.DataArray): DataArray containing the MSI index for the final period of time.</span>

<span class="sd">    Returns:</span>
<span class="sd">        xarray.Dataset: Dataset containing the magnitude.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">x1</span> <span class="o">=</span> <span class="n">ndmi_post</span> <span class="o">-</span> <span class="n">ndmi_pre</span>
    <span class="n">y1</span> <span class="o">=</span> <span class="n">nbr_post</span> <span class="o">-</span> <span class="n">nbr_pre</span>
    <span class="n">z1</span> <span class="o">=</span> <span class="n">msi_post</span> <span class="o">-</span> <span class="n">msi_pre</span>

    <span class="c1"># va = xr.merge([x1, y1, z1]).to_dataset(&#39;band&#39;).rename({1: &#39;ndmi_va&#39;, 2: &#39;nbr_va&#39;, 3: &#39;msi_va&#39;})</span>

    <span class="n">modulo_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x1</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y1</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">z1</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">phi_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">y1</span> <span class="o">/</span> <span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="mf">3.1416</span>
    <span class="n">theta_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">z1</span> <span class="o">/</span> <span class="n">modulo_a</span><span class="p">)</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="mf">3.1416</span>

    <span class="n">phi_a</span> <span class="o">=</span> <span class="n">phi_a</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x1</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">phi_a</span> <span class="o">+</span> <span class="mi">180</span><span class="p">)</span>
    <span class="n">p_theta_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">theta_a</span> <span class="o">-</span> <span class="mi">45</span><span class="p">)</span>
    <span class="n">p_theta_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="mi">135</span> <span class="o">-</span> <span class="n">p_theta_a</span><span class="p">)</span> <span class="o">/</span> <span class="mi">135</span><span class="p">)</span>
    <span class="n">p_phi_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">phi_a</span> <span class="o">-</span> <span class="mi">225</span><span class="p">)</span>
    <span class="n">p_phi_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="mi">315</span> <span class="o">-</span> <span class="n">p_phi_a</span><span class="p">)</span> <span class="o">/</span> <span class="mi">315</span><span class="p">)</span>

    <span class="n">magnitude</span> <span class="o">=</span> <span class="p">(</span><span class="n">p_theta_a</span> <span class="o">+</span> <span class="n">p_phi_a</span> <span class="o">+</span> <span class="n">modulo_a</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span>
    <span class="n">magnitude</span> <span class="o">=</span> <span class="n">magnitude</span> <span class="o">*</span> <span class="mi">255</span>
    <span class="c1"># magnitude = magnitude.where(magnitude &lt;= 255, 255)</span>

    <span class="k">return</span> <span class="n">magnitude</span></div>


<div class="viewcode-block" id="calculate_magnitude_trio"><a class="viewcode-back" href="../../packages/chains.module.html#chains.module.calculate_magnitude_trio">[docs]</a><span class="k">def</span> <span class="nf">calculate_magnitude_trio</span><span class="p">(</span>
    <span class="n">ndmi_pre</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">,</span>
    <span class="n">nbr_pre</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">,</span>
    <span class="n">msi_pre</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">,</span>
    <span class="n">ndmi_x</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">,</span>
    <span class="n">nbr_x</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">,</span>
    <span class="n">msi_x</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">,</span>
    <span class="n">ndmi_post</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">,</span>
    <span class="n">nbr_post</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">,</span>
    <span class="n">msi_post</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given nine Xarray DataArray containing the NDMI, NBR and MSI indexes over three</span>
<span class="sd">    concatenated periods of time, uses the 3I3D algorithm to compute</span>
<span class="sd">    the change magnitude.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        ndmi_pre (xarray.DataArray): DataArray containing the NDMI index for the initial period of time.</span>
<span class="sd">        nbr_pre (xarray.DataArray): DataArray containing the NBR index for the initial period of time.</span>
<span class="sd">        msi_pre (xarray.DataArray): DataArray containing the MSI index for the initial period of time.</span>
<span class="sd">        ndmi_post (xarray.DataArray): DataArray containing the NDMI index for the final period of time.</span>
<span class="sd">        nbr_post (xarray.DataArray): DataArray containing the NBR index for the final period of time.</span>
<span class="sd">        msi_post (xarray.DataArray): DataArray containing the MSI index for the final period of time.</span>

<span class="sd">    Returns:</span>
<span class="sd">        xarray.Dataset: Dataset containing the change magnitude.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Sentinel-2 L2A bands common name</span>
    <span class="c1"># [&#39;B02&#39;,&#39;B03&#39;,&#39;B04&#39;,&#39;B05&#39;,&#39;B06&#39;,&#39;B07&#39;,&#39;B08&#39;,&#39;B8A&#39;,&#39;B11&#39;,&#39;B12&#39;]</span>
    <span class="c1"># [&#39;blue&#39;, &#39;green&#39;, &#39;red&#39;, &#39;redE1&#39;, &#39;redE2&#39;, &#39;redE3&#39;, &#39;nir&#39;, &#39;redE4&#39;, &#39;swir1&#39;, &#39;swir2&#39;]</span>

    <span class="n">x1</span> <span class="o">=</span> <span class="n">ndmi_x</span> <span class="o">-</span> <span class="n">ndmi_pre</span>
    <span class="n">y1</span> <span class="o">=</span> <span class="n">nbr_x</span> <span class="o">-</span> <span class="n">nbr_pre</span>
    <span class="n">z1</span> <span class="o">=</span> <span class="n">msi_x</span> <span class="o">-</span> <span class="n">msi_pre</span>

    <span class="n">x2</span> <span class="o">=</span> <span class="n">ndmi_post</span> <span class="o">-</span> <span class="n">ndmi_x</span>
    <span class="n">y2</span> <span class="o">=</span> <span class="n">nbr_post</span> <span class="o">-</span> <span class="n">nbr_x</span>
    <span class="n">z2</span> <span class="o">=</span> <span class="n">msi_post</span> <span class="o">-</span> <span class="n">msi_x</span>

    <span class="n">modulo_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x1</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y1</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">z1</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">phi_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">y1</span> <span class="o">/</span> <span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="mf">3.1416</span>
    <span class="n">theta_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">z1</span> <span class="o">/</span> <span class="n">modulo_a</span><span class="p">)</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="mf">3.1416</span>

    <span class="n">phi_a</span> <span class="o">=</span> <span class="n">phi_a</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x1</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">phi_a</span> <span class="o">+</span> <span class="mi">180</span><span class="p">)</span>
    <span class="n">p_theta_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">theta_a</span> <span class="o">-</span> <span class="mi">45</span><span class="p">)</span>
    <span class="n">p_theta_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="mi">135</span> <span class="o">-</span> <span class="n">p_theta_a</span><span class="p">)</span> <span class="o">/</span> <span class="mi">135</span><span class="p">)</span>
    <span class="n">p_phi_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">phi_a</span> <span class="o">-</span> <span class="mi">225</span><span class="p">)</span>
    <span class="n">p_phi_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="mi">315</span> <span class="o">-</span> <span class="n">p_phi_a</span><span class="p">)</span> <span class="o">/</span> <span class="mi">315</span><span class="p">)</span>

    <span class="c1"># magnitude = (p_theta_a + p_phi_a + modulo_a) / 3</span>
    <span class="c1"># magnitude = magnitude * 255</span>
    <span class="c1"># magnitude = magnitude.where(magnitude &lt;= 255, 255).astype(&#39;uint8&#39;)</span>

    <span class="n">modulo_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">z2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">phi_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">y2</span> <span class="o">/</span> <span class="n">x2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="mf">3.1416</span>
    <span class="n">theta_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">z2</span> <span class="o">/</span> <span class="n">modulo_b</span><span class="p">)</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="mf">3.1416</span>
    <span class="n">phi_b</span> <span class="o">=</span> <span class="n">phi_b</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x2</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">phi_b</span> <span class="o">+</span> <span class="mi">180</span><span class="p">)</span>
    <span class="n">p_theta_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">theta_b</span> <span class="o">-</span> <span class="mi">135</span><span class="p">)</span>
    <span class="n">p_theta_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="mi">135</span> <span class="o">-</span> <span class="n">p_theta_b</span><span class="p">)</span> <span class="o">/</span> <span class="mi">135</span><span class="p">)</span>
    <span class="n">p_phi_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">phi_b</span> <span class="o">-</span> <span class="mi">45</span><span class="p">)</span>
    <span class="n">p_phi_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="mi">225</span> <span class="o">-</span> <span class="n">p_phi_b</span><span class="p">)</span> <span class="o">/</span> <span class="mi">225</span><span class="p">)</span>

    <span class="n">de</span> <span class="o">=</span> <span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y1</span> <span class="o">-</span> <span class="n">y2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">z1</span> <span class="o">-</span> <span class="n">z2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>

    <span class="n">magnitude</span> <span class="o">=</span> <span class="p">(</span><span class="n">p_theta_a</span> <span class="o">+</span> <span class="n">p_theta_b</span> <span class="o">+</span> <span class="n">p_phi_a</span> <span class="o">+</span> <span class="n">p_phi_b</span> <span class="o">+</span> <span class="n">de</span><span class="p">)</span> <span class="o">/</span> <span class="mi">5</span>
    <span class="n">magnitude</span> <span class="o">=</span> <span class="n">magnitude</span> <span class="o">*</span> <span class="mi">255</span>
    <span class="c1"># magnitude = magnitude.where(magnitude &lt;= 255, 255).astype(&#39;uint8&#39;)</span>

    <span class="k">return</span> <span class="n">magnitude</span></div>


<div class="viewcode-block" id="apply_mmu_img"><a class="viewcode-back" href="../../packages/chains.module.html#chains.module.apply_mmu_img">[docs]</a><span class="k">def</span> <span class="nf">apply_mmu_img</span><span class="p">(</span><span class="n">da</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">,</span> <span class="n">mmu</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fill holes and discards objects smaller than the Minimum Mapping Unit (MMU) in a binary change map</span>
<span class="sd">    represented by a 2D DataArray.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    - da (xarray.DataArray): Input change map represented as a 2D DataArray.</span>
<span class="sd">    - mmu (int): Minimum Mapping Unit, specifying the minimum size (in pixels) for retained objects.</span>

<span class="sd">    Returns:</span>
<span class="sd">    - xarray.DataArray: Modified change map with objects smaller than the MMU removed.</span>

<span class="sd">    Raises:</span>
<span class="sd">    - AssertionError: If the input change map contains values other than 0 and 1.</span>

<span class="sd">    The function identifies connected components (objects) in the change map and removes objects</span>
<span class="sd">    smaller than the specified MMU. It ensures that the resulting change map maintains the original</span>
<span class="sd">    NoData values and Coordinate Reference System (CRS).</span>

<span class="sd">    Note: This function uses the scikit-image.ndimage module for labeling connected components.</span>

<span class="sd">    Example:</span>
<span class="sd">    ```python</span>
<span class="sd">    import xarray as xr</span>
<span class="sd">    from apply_mmu import apply_mmu_img</span>

<span class="sd">    # Assuming &#39;change_map&#39; is a 2D DataArray with a NoData value</span>
<span class="sd">    mmu_value = 100  # Set the desired MMU value</span>
<span class="sd">    modified_change_map = apply_mmu_img(change_map, mmu_value)</span>
<span class="sd">    ```</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nodata_value</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">nodata</span>
    <span class="n">crs</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">crs</span>

    <span class="c1"># the change mask must only contain 0 and 1 values, where 0 is considered background and 1 identifies pixels of interest for the mmu</span>
    <span class="n">da_new</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">da</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">da_new</span> <span class="o">=</span> <span class="n">da_new</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">da</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">da_new</span> <span class="o">=</span> <span class="n">da_new</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">da</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">img_array</span> <span class="o">=</span> <span class="n">da_new</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">da_new</span> <span class="o">!=</span> <span class="n">nodata_value</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">assert</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">img_array</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">img_array</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="s2">&quot;Change map must only have 0 and 1 values.&quot;</span>

    <span class="c1"># plus-shaped kernel with radius 1 for morphological operations</span>
    <span class="n">plus_shaped_kernel</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">generate_binary_structure</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># swaps zeros with ones in order to find small patches of zeros (small holes)</span>
    <span class="n">img_array_neg</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">img_array</span> <span class="o">==</span> <span class="kc">True</span><span class="p">))</span> <span class="o">*</span> <span class="mi">1</span>

    <span class="c1"># finds all connected components (objects) by superimposing a plus-shaped kernel with radius 1 on each non-zero element of the image</span>
    <span class="c1"># labeled_array has the same shape as the input change map, but pixels of each object have a unique integer value</span>
    <span class="c1"># num_features is the number of objects found</span>
    <span class="n">labeled_array</span><span class="p">,</span> <span class="n">num_features</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">label</span><span class="p">(</span>
        <span class="n">img_array_neg</span><span class="p">,</span> <span class="n">structure</span><span class="o">=</span><span class="n">plus_shaped_kernel</span>
    <span class="p">)</span>

    <span class="c1"># sums values in the change map inside the regions defined by labels (i.e. inside objects)</span>
    <span class="c1"># objects_areas contains the number of pixels (i.e. the area) inside each object</span>
    <span class="n">objects_areas</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
        <span class="n">img_array_neg</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labeled_array</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_features</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># fills only objects smaller than (or equal to) the mmu</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">objects_areas</span> <span class="o">&lt;=</span> <span class="n">mmu</span>
    <span class="n">labels_to_fill</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
    <span class="c1"># uses a mask matrix to only fill these objects</span>
    <span class="c1"># the mask matrix is True everywhere except in objects to fill</span>
    <span class="n">mask_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">labeled_array</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">labels_to_fill</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="c1"># puts False in objects to fill (i.e. objects with the selected label)</span>
        <span class="n">mask_matrix</span> <span class="o">*=</span> <span class="o">~</span><span class="p">(</span><span class="n">labeled_array</span> <span class="o">==</span> <span class="n">label</span><span class="p">)</span>

    <span class="c1"># puts a 1 in the small holes (the negation of the mask matrix identifies pixels to fill)</span>
    <span class="n">img_array_filled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">mask_matrix</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">img_array</span><span class="p">)</span>
    <span class="n">img_array</span> <span class="o">=</span> <span class="n">img_array_filled</span>

    <span class="c1"># same as above, but to find objects larger than (or equal to) the mmu</span>
    <span class="n">labeled_array</span><span class="p">,</span> <span class="n">num_features</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">img_array</span><span class="p">,</span> <span class="n">structure</span><span class="o">=</span><span class="n">plus_shaped_kernel</span><span class="p">)</span>

    <span class="n">objects_areas</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
        <span class="n">img_array</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labeled_array</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_features</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># keeps only objects larger than (or equal to) the mmu</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">objects_areas</span> <span class="o">&gt;=</span> <span class="n">mmu</span>
    <span class="n">labels_to_keep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
    <span class="c1"># uses a mask matrix to only keep these objects</span>
    <span class="c1"># the mask matrix is True everywhere except in objects to keep</span>
    <span class="n">mask_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">labeled_array</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">labels_to_keep</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="c1"># puts False in objects to keep (i.e. objects with the selected label)</span>
        <span class="n">mask_matrix</span> <span class="o">*=</span> <span class="o">~</span><span class="p">(</span><span class="n">labeled_array</span> <span class="o">==</span> <span class="n">label</span><span class="p">)</span>

    <span class="c1"># updates the change mask</span>
    <span class="n">da_new</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="c1"># the negation of the mask matrix identifies pixels to keep</span>
    <span class="n">img_array_masked</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">mask_matrix</span><span class="p">,</span> <span class="n">img_array</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">da_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">img_array_masked</span>

    <span class="c1"># restores no-values and crs from the original change map</span>
    <span class="n">da_new</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">da</span> <span class="o">==</span> <span class="n">nodata_value</span><span class="p">,</span> <span class="n">da</span><span class="p">,</span> <span class="n">da_new</span><span class="p">)</span>
    <span class="n">da_new</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">da</span> <span class="o">==</span> <span class="mi">3</span><span class="p">,</span> <span class="n">da</span><span class="p">,</span> <span class="n">da_new</span><span class="p">)</span>
    <span class="n">da_new</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">da_new</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">da_new</span><span class="p">)</span>
    <span class="n">da_new</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">da_new</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">da_new</span><span class="p">)</span>
    <span class="n">da_new</span> <span class="o">=</span> <span class="n">da_new</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">write_crs</span><span class="p">(</span><span class="n">crs</span><span class="p">)</span>
    <span class="n">da_new</span> <span class="o">=</span> <span class="n">da_new</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">set_nodata</span><span class="p">(</span><span class="n">nodata_value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">da_new</span></div>


<div class="viewcode-block" id="compute_change"><a class="viewcode-back" href="../../packages/chains.module.html#chains.module.compute_change">[docs]</a><span class="nd">@retry</span><span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="n">tries</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compute_change</span><span class="p">(</span>
    <span class="n">magnitude</span><span class="p">,</span>
    <span class="n">th</span><span class="p">,</span>
    <span class="n">fn_path</span><span class="p">,</span>
    <span class="n">save_path</span><span class="p">,</span>
    <span class="n">save_path_cog</span><span class="p">,</span>
    <span class="n">stac_epsg</span><span class="p">,</span>
    <span class="n">epsg</span><span class="p">,</span>
    <span class="n">save_flag</span><span class="p">,</span>
    <span class="n">clip_geometry</span><span class="p">,</span>
    <span class="n">overwrite</span><span class="p">,</span>
    <span class="n">mmu</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    This method takes the results of calculate_magnitude_trio function (implementation of 3I3D algorithm for the SVC-S4-7b)</span>
<span class="sd">    and it computes forest disturbance map based on a given magnitude threshold defined in the config file.</span>
<span class="sd">    This step results in a forest disturbance map classified into disturbed (value = 2) and undisturbed classes (value=1),</span>
<span class="sd">    No-Data (value=255). These values have been defined by e-Geos.</span>
<span class="sd">    It optionally applys the MMU.</span>
<span class="sd">    It is worth noting that the forest disturbance approach is applied to forest covers, thus, a forest mask is needed.</span>
<span class="sd">    It takes the following parameters:</span>

<span class="sd">    Parameters:</span>
<span class="sd">    - magnitude: A DataArray representing the magnitude of change.</span>
<span class="sd">    - th: The threshold value to determine change.</span>
<span class="sd">    - fn_path: The file path of the fnf mask.</span>
<span class="sd">    - save_path: The file path to save the output raster.</span>
<span class="sd">    - save_path_cog: The file path to save the output raster as a COG (Cloud-Optimized GeoTIFF).</span>
<span class="sd">    - stac_epsg: The EPSG code of the input magnitude data.</span>
<span class="sd">    - epsg: The EPSG code of the desired output projection.</span>
<span class="sd">    - save_flag: A boolean flag indicating whether to save the output raster.</span>
<span class="sd">    - clip_geometry: A geometry object to clip the output raster.</span>
<span class="sd">    - overwrite: A boolean flag indicating whether to overwrite the output file if it already exists.</span>
<span class="sd">    - mmu: The minimum mapping unit. Default value is 1.</span>

<span class="sd">    The method performs the following steps:</span>

<span class="sd">    1. Checks for missing values in the magnitude DataArray.</span>
<span class="sd">    2. Divides the magnitude DataArray into two classes based on the threshold value: values &gt;= threshold are considered class 2, otherwise class 1.</span>
<span class="sd">    3. Sets class 3 (missing values) in the change DataArray based on the missing values in the magnitude DataArray.</span>
<span class="sd">    4. Sets the CRS (Coordinate Reference System) of the change DataArray using the provided stac_epsg value, and reprojects it to the desired EPSG using the epsg value.</span>
<span class="sd">    5. Applies the fnf mask (forest mask) to the change DataArray using the fn_path and epsg values.</span>
<span class="sd">    6. If mmu value is greater than 1, applies the minimum mapping unit to the change DataArray using the apply_mmu_img function.</span>
<span class="sd">    7. If save_flag is True or the output file does not exist (and overwrite is True), proceeds to save the change DataArray as a GeoTIFF file.</span>
<span class="sd">    8. Clips the change DataArray based on the provided clip_geometry.</span>
<span class="sd">    9. Writes the change DataArray without a nodata value using the rio.write_nodata method.</span>
<span class="sd">    10. Saves the change DataArray as a GeoTIFF file using the save_path and save_path_cog values.</span>
<span class="sd">    11. Returns the change DataArray.</span>

<span class="sd">    Note: This method uses the @retry decorator to automatically retry the method in case of a RuntimeError. The retry decorator is not provided in this documentation.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">magnitude_isna</span> <span class="o">=</span> <span class="n">magnitude</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span>

    <span class="n">change</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">magnitude</span> <span class="o">&gt;=</span> <span class="n">th</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">change</span> <span class="o">=</span> <span class="n">change</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">magnitude_isna</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">change</span> <span class="o">=</span> <span class="n">change</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">write_crs</span><span class="p">(</span><span class="s2">&quot;EPSG:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stac_epsg</span><span class="p">))</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">reproject</span><span class="p">(</span>
        <span class="s2">&quot;EPSG:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epsg</span><span class="p">),</span> <span class="n">nodata</span><span class="o">=</span><span class="mi">255</span>
    <span class="p">)</span>

    <span class="n">change</span> <span class="o">=</span> <span class="n">apply_fnf_mask</span><span class="p">(</span><span class="n">change</span><span class="p">,</span> <span class="n">fn_path</span><span class="p">,</span> <span class="n">epsg</span><span class="p">)</span>

    <span class="c1"># filling nan from fnf mask</span>
    <span class="c1"># change = change.fillna(255)</span>
    <span class="c1"># change.rio.set_nodata(255)</span>

    <span class="c1"># Optionally applys the MMU</span>
    <span class="k">if</span> <span class="n">mmu</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">change</span> <span class="o">=</span> <span class="n">apply_mmu_img</span><span class="p">(</span><span class="n">da</span><span class="o">=</span><span class="n">change</span><span class="p">,</span> <span class="n">mmu</span><span class="o">=</span><span class="n">mmu</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">save_flag</span> <span class="ow">and</span> <span class="p">(</span><span class="n">overwrite</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">save_path</span><span class="p">))):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">change</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">change</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Dimension of 3I3D output is null, cannot create geotiff file.&quot;</span>
                <span class="p">)</span>

            <span class="c1"># clips the result on the provided area of interest</span>
            <span class="k">if</span> <span class="n">clip_geometry</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">change</span> <span class="o">=</span> <span class="n">clip_raster_by_vector</span><span class="p">(</span><span class="n">change</span><span class="p">,</span> <span class="n">clip_geometry</span><span class="p">)</span>

            <span class="n">change</span> <span class="o">=</span> <span class="n">change</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">write_nodata</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">change</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">to_raster</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>
            <span class="n">save_cog</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">save_path_cog</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">RasterioIOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during tiff creation: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validation error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">change</span></div>


<div class="viewcode-block" id="compute_classification"><a class="viewcode-back" href="../../packages/chains.module.html#chains.module.compute_classification">[docs]</a><span class="nd">@retry</span><span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="n">tries</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compute_classification</span><span class="p">(</span>
    <span class="n">magnitude</span><span class="p">,</span>
    <span class="n">fn_path</span><span class="p">,</span>
    <span class="n">save_path</span><span class="p">,</span>
    <span class="n">save_path_cog</span><span class="p">,</span>
    <span class="n">stac_epsg</span><span class="p">,</span>
    <span class="n">epsg</span><span class="p">,</span>
    <span class="n">save_flag</span><span class="p">,</span>
    <span class="n">clip_geometry</span><span class="p">,</span>
    <span class="n">overwrite</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Compute Classification</span>

<span class="sd">    This method computes the classification of a given magnitude dataset.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    - `magnitude` (xarray.DataArray): The magnitude dataset.</span>
<span class="sd">    - `fn_path` (str): The file path to the FNF mask dataset.</span>
<span class="sd">    - `save_path` (str): The file path to save the classification raster.</span>
<span class="sd">    - `save_path_cog` (str): The file path to save the classification raster as a Cloud-Optimized GeoTIFF (COG).</span>
<span class="sd">    - `stac_epsg` (int): The EPSG code of the original magnitude dataset.</span>
<span class="sd">    - `epsg` (int): The EPSG code to reproject the classification raster.</span>
<span class="sd">    - `save_flag` (bool): Flag to indicate whether to save the classification raster or not.</span>
<span class="sd">    - `clip_geometry` (ogr.Geometry): Optional geometry object to clip the classification raster.</span>
<span class="sd">    - `overwrite` (bool): Flag to indicate whether to overwrite existing classification raster if it exists.</span>

<span class="sd">    Returns:</span>
<span class="sd">    - `classes` (xarray.DataArray): The computed classification raster.</span>

<span class="sd">    Raises:</span>
<span class="sd">    - `ValueError`: If the dimension of the magnitude output is null.</span>
<span class="sd">    - `rasterio.errors.RasterioIOError`: If there is an error during TIFF creation.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">save_path</span><span class="p">))</span> <span class="ow">or</span> <span class="n">overwrite</span><span class="p">:</span>
        <span class="n">class0</span> <span class="o">=</span> <span class="n">magnitude</span> <span class="o">&lt;=</span> <span class="mi">170</span>
        <span class="n">class1</span> <span class="o">=</span> <span class="p">(</span><span class="n">magnitude</span> <span class="o">&gt;</span> <span class="mi">170</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">magnitude</span> <span class="o">&lt;=</span> <span class="mi">190</span><span class="p">)</span>
        <span class="n">class2</span> <span class="o">=</span> <span class="p">(</span><span class="n">magnitude</span> <span class="o">&gt;</span> <span class="mi">190</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">magnitude</span> <span class="o">&lt;=</span> <span class="mi">210</span><span class="p">)</span>
        <span class="n">class3</span> <span class="o">=</span> <span class="n">magnitude</span> <span class="o">&gt;</span> <span class="mi">210</span>
        <span class="n">classna</span> <span class="o">=</span> <span class="n">magnitude</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span>

        <span class="n">classes</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">class0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">magnitude</span><span class="p">)</span>
        <span class="n">classes</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">class1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">classes</span><span class="p">)</span>
        <span class="n">classes</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">class2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">classes</span><span class="p">)</span>
        <span class="n">classes</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">class3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">classes</span><span class="p">)</span>
        <span class="n">classes</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">classna</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">classes</span><span class="p">)</span>

        <span class="n">classes</span> <span class="o">=</span> <span class="n">classes</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">write_crs</span><span class="p">(</span><span class="s2">&quot;EPSG:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stac_epsg</span><span class="p">))</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">reproject</span><span class="p">(</span>
            <span class="s2">&quot;EPSG:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epsg</span><span class="p">),</span> <span class="n">nodata</span><span class="o">=</span><span class="mi">255</span>
        <span class="p">)</span>
        <span class="n">classes</span> <span class="o">=</span> <span class="n">apply_fnf_mask</span><span class="p">(</span><span class="n">classes</span><span class="p">,</span> <span class="n">fn_path</span><span class="p">,</span> <span class="n">epsg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">save_flag</span> <span class="ow">and</span> <span class="p">(</span><span class="n">overwrite</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">save_path</span><span class="p">))):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">classes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">classes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;Dimension of 3I3D output is null, cannot create geotiff file.&quot;</span>
                    <span class="p">)</span>

                <span class="c1"># clips the result on the provided area of interest</span>
                <span class="k">if</span> <span class="n">clip_geometry</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">classes</span> <span class="o">=</span> <span class="n">clip_raster_by_vector</span><span class="p">(</span><span class="n">classes</span><span class="p">,</span> <span class="n">clip_geometry</span><span class="p">)</span>

                <span class="n">classes</span> <span class="o">=</span> <span class="n">classes</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
                <span class="c1"># filling nan from fnf mask</span>
                <span class="c1"># classes = classes.fillna(255)</span>
                <span class="c1"># classes.rio.set_nodata(255)</span>
                <span class="n">classes</span> <span class="o">=</span> <span class="n">classes</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">write_nodata</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="n">classes</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">to_raster</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>
                <span class="n">save_cog</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">save_path_cog</span><span class="p">)</span>

            <span class="k">except</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">RasterioIOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during tiff creation: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validation error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">classes</span> <span class="o">=</span> <span class="n">rio</span><span class="o">.</span><span class="n">open_rasterio</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="s2">&quot;auto&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
    <span class="c1"># classes = classes.compute()</span>

    <span class="k">return</span> <span class="n">classes</span></div>


<div class="viewcode-block" id="ufunc_classify"><a class="viewcode-back" href="../../packages/chains.module.html#chains.module.ufunc_classify">[docs]</a><span class="k">def</span> <span class="nf">ufunc_classify</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Classifies a given value into one of five categories based on certain conditions.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    - value: A numeric value that needs to be classified.</span>

<span class="sd">    Returns:</span>
<span class="sd">    - An integer representing the category of the given value. The possible categories are: 1, 2, 3, 4, or 5.</span>

<span class="sd">    If the given value does not fall into any category, the method returns np.nan.</span>

<span class="sd">    Example Usage:</span>
<span class="sd">    &gt;&gt;&gt; ufunc_classify(1.5)</span>
<span class="sd">    2</span>

<span class="sd">    &gt;&gt;&gt; ufunc_classify(6)</span>
<span class="sd">    nan</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cond1</span> <span class="o">=</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">&lt;=</span> <span class="mi">1</span>
    <span class="n">cond2</span> <span class="o">=</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">&lt;=</span> <span class="mi">2</span>
    <span class="n">cond3</span> <span class="o">=</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">&lt;=</span> <span class="mi">3</span>
    <span class="n">cond4</span> <span class="o">=</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">&lt;=</span> <span class="mi">4</span>
    <span class="n">cond5</span> <span class="o">=</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mi">4</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">&lt;=</span> <span class="mi">5</span>

    <span class="k">if</span> <span class="n">cond1</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">cond2</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">2</span>
    <span class="k">elif</span> <span class="n">cond3</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">3</span>
    <span class="k">elif</span> <span class="n">cond4</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">4</span>
    <span class="k">elif</span> <span class="n">cond5</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">5</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span></div>


<div class="viewcode-block" id="ufunc_reclassify"><a class="viewcode-back" href="../../packages/chains.module.html#chains.module.ufunc_reclassify">[docs]</a><span class="k">def</span> <span class="nf">ufunc_reclassify</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reclassifies a value based on the lookup table.</span>

<span class="sd">    Args:</span>
<span class="sd">        value (int): The value to be reclassified.</span>
<span class="sd">        table (dict): A lookup table that maps input values to output values.</span>

<span class="sd">    Returns:</span>
<span class="sd">        int: The reclassified value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">!=</span> <span class="mi">255</span><span class="p">:</span>
        <span class="n">reclassified</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="n">value</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">reclassified</span> <span class="o">=</span> <span class="mi">255</span>
    <span class="k">return</span> <span class="n">reclassified</span></div>


<div class="viewcode-block" id="compute_vulnerability"><a class="viewcode-back" href="../../packages/chains.module.html#chains.module.compute_vulnerability">[docs]</a><span class="nd">@retry</span><span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="n">tries</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compute_vulnerability</span><span class="p">(</span>
    <span class="n">classes</span><span class="p">,</span>
    <span class="n">ft_path</span><span class="p">,</span>
    <span class="n">ft_cod_path</span><span class="p">,</span>
    <span class="n">save_path</span><span class="p">,</span>
    <span class="n">save_path_cog</span><span class="p">,</span>
    <span class="n">epsg</span><span class="p">,</span>
    <span class="n">save_flag</span><span class="p">,</span>
    <span class="n">clip_geometry</span><span class="p">,</span>
    <span class="n">overwrite</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    This method computes vulnerability based on the given inputs and saves the result as a GeoTIFF file.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    - classes: A rasterio.DatasetReader object representing the classified classes.</span>
<span class="sd">    - ft_path: A string representing the file path of the feature raster.</span>
<span class="sd">    - ft_cod_path: A string representing the file path of the feature code table.</span>
<span class="sd">    - save_path: A string representing the file path to save the vulnerability result.</span>
<span class="sd">    - save_path_cog: A string representing the file path to save the Cloud-Optimized GeoTIFF (COG).</span>
<span class="sd">    - epsg: An integer representing the EPSG code for the desired coordinate reference system (CRS).</span>
<span class="sd">    - save_flag: A boolean indicating whether to save the result or not.</span>
<span class="sd">    - clip_geometry: A GeoJSON-like object representing the geometry with which to clip the result.</span>
<span class="sd">    - overwrite: A boolean indicating whether to overwrite an existing file with the same save path.</span>

<span class="sd">    Returns:</span>
<span class="sd">    - vulnerability: A rasterio.DatasetReader object representing the vulnerability result.</span>

<span class="sd">    Note: This method uses the &#39;retry&#39; decorator to retry the execution of the method if a &#39;RuntimeError&#39; occurs. The maximum number of tries is 10, and there is a 2-second delay between</span>
<span class="sd">    * each try.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">classes</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">set_nodata</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span>
    <span class="n">classes</span> <span class="o">=</span> <span class="n">classes</span><span class="o">.</span><span class="n">to_dataset</span><span class="p">(</span><span class="s2">&quot;band&quot;</span><span class="p">)</span>

    <span class="n">classified_fha_data</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">classes</span> <span class="o">==</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="n">classes</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">classified_fha_data</span> <span class="o">=</span> <span class="n">classified_fha_data</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">write_crs</span><span class="p">(</span><span class="n">classes</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
    <span class="n">classified_fha_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">classified_fha_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;int64&quot;</span><span class="p">)</span>

    <span class="n">ft_raster</span> <span class="o">=</span> <span class="n">rio</span><span class="o">.</span><span class="n">open_rasterio</span><span class="p">(</span><span class="n">ft_path</span><span class="p">)</span>
    <span class="n">ft_raster</span> <span class="o">=</span> <span class="n">ft_raster</span><span class="o">.</span><span class="n">to_dataset</span><span class="p">(</span><span class="s2">&quot;band&quot;</span><span class="p">)</span>

    <span class="n">classified_fha_data_repr</span> <span class="o">=</span> <span class="n">classified_fha_data</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">reproject_match</span><span class="p">(</span>
        <span class="n">ft_raster</span><span class="p">,</span> <span class="n">resampling</span><span class="o">=</span><span class="n">rasterio</span><span class="o">.</span><span class="n">enums</span><span class="o">.</span><span class="n">Resampling</span><span class="o">.</span><span class="n">bilinear</span>
    <span class="p">)</span>
    <span class="n">classified_fha_resampled</span> <span class="o">=</span> <span class="n">classified_fha_data_repr</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">ft_raster</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
            <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">ft_raster</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>

    <span class="n">classified_fha_resampled</span> <span class="o">=</span> <span class="n">classified_fha_resampled</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">clip_box</span><span class="p">(</span>
        <span class="o">*</span><span class="n">classified_fha_data</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">bounds</span><span class="p">(),</span> <span class="n">crs</span><span class="o">=</span><span class="n">classified_fha_data</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">crs</span>
    <span class="p">)</span>
    <span class="n">ft_raster</span> <span class="o">=</span> <span class="n">ft_raster</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">clip_box</span><span class="p">(</span>
        <span class="o">*</span><span class="n">classified_fha_data</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">bounds</span><span class="p">(),</span> <span class="n">crs</span><span class="o">=</span><span class="n">classified_fha_data</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">crs</span>
    <span class="p">)</span>

    <span class="n">cond1</span> <span class="o">=</span> <span class="p">(</span><span class="n">classified_fha_resampled</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">classified_fha_resampled</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">cond2</span> <span class="o">=</span> <span class="p">(</span><span class="n">classified_fha_resampled</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">classified_fha_resampled</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">cond3</span> <span class="o">=</span> <span class="p">(</span><span class="n">classified_fha_resampled</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">classified_fha_resampled</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">cond4</span> <span class="o">=</span> <span class="p">(</span><span class="n">classified_fha_resampled</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">classified_fha_resampled</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">cond5</span> <span class="o">=</span> <span class="p">(</span><span class="n">classified_fha_resampled</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">classified_fha_resampled</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">cond6</span> <span class="o">=</span> <span class="p">(</span><span class="n">classified_fha_resampled</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">classified_fha_resampled</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>

    <span class="n">cmask_raster_FHA</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cond1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">classified_fha_resampled</span><span class="p">)</span>
    <span class="n">cmask_raster_FHA</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cond2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">cmask_raster_FHA</span><span class="p">)</span>
    <span class="n">cmask_raster_FHA</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cond3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">cmask_raster_FHA</span><span class="p">)</span>
    <span class="n">cmask_raster_FHA</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cond4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">cmask_raster_FHA</span><span class="p">)</span>
    <span class="n">cmask_raster_FHA</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cond5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">cmask_raster_FHA</span><span class="p">)</span>
    <span class="n">cmask_raster_FHA</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cond6</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="n">cmask_raster_FHA</span><span class="p">)</span>

    <span class="n">masked_ft</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">classified_fha_resampled</span> <span class="o">!=</span> <span class="mi">255</span><span class="p">,</span> <span class="n">ft_raster</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;int64&quot;</span><span class="p">),</span> <span class="mi">255</span>
    <span class="p">)</span>
    <span class="n">overlapped_raster</span> <span class="o">=</span> <span class="p">(</span><span class="n">masked_ft</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)</span> <span class="o">**</span> <span class="n">cmask_raster_FHA</span>

    <span class="n">df_cat_ft</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">ft_cod_path</span><span class="p">)</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="n">df_cat_ft</span><span class="p">[</span><span class="s2">&quot;Num_ID&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">df_cat_ft</span><span class="p">[</span><span class="s2">&quot;ID&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">correspondence_table</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">values</span><span class="p">)}</span>

    <span class="n">vulnerability</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
        <span class="n">ufunc_reclassify</span><span class="p">,</span>
        <span class="n">overlapped_raster</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;table&quot;</span><span class="p">:</span> <span class="n">correspondence_table</span><span class="p">},</span>
        <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[[]],</span>
        <span class="n">dask</span><span class="o">=</span><span class="s2">&quot;parallelized&quot;</span><span class="p">,</span>
        <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;float64&quot;</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="n">vulnerability</span> <span class="o">=</span> <span class="n">vulnerability</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">write_crs</span><span class="p">(</span>
        <span class="n">classified_fha_resampled</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">crs</span>
    <span class="p">)</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">reproject</span><span class="p">(</span><span class="s2">&quot;EPSG:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epsg</span><span class="p">),</span> <span class="n">nodata</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
    <span class="n">vulnerability</span> <span class="o">=</span> <span class="n">vulnerability</span><span class="o">.</span><span class="n">to_dataset</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;vulnerability&quot;</span><span class="p">})</span>

    <span class="k">if</span> <span class="n">save_flag</span> <span class="ow">and</span> <span class="p">(</span><span class="n">overwrite</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">save_path</span><span class="p">))):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vulnerability</span><span class="o">.</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">vulnerability</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Dimension of 3I3D output is null, cannot create geotiff file.&quot;</span>
                <span class="p">)</span>

            <span class="c1"># clips the result on the provided area of interest</span>
            <span class="k">if</span> <span class="n">clip_geometry</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">vulnerability</span> <span class="o">=</span> <span class="n">clip_raster_by_vector</span><span class="p">(</span><span class="n">vulnerability</span><span class="p">,</span> <span class="n">clip_geometry</span><span class="p">)</span>

            <span class="c1"># filling nan from fnf mask</span>
            <span class="c1"># vulnerability = vulnerability.fillna(255)</span>
            <span class="c1"># vulnerability.to_array().rio.set_nodata(255).rio.to_raster(save_path)</span>
            <span class="n">vulnerability</span> <span class="o">=</span> <span class="n">vulnerability</span><span class="o">.</span><span class="n">to_array</span><span class="p">()</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">write_nodata</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">vulnerability</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">to_raster</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>
            <span class="n">save_cog</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">save_path_cog</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">RasterioIOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during tiff creation: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validation error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">vulnerability</span></div>


<div class="viewcode-block" id="save_input_zarr"><a class="viewcode-back" href="../../packages/chains.module.html#chains.module.save_input_zarr">[docs]</a><span class="nd">@retry</span><span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="n">tries</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">save_input_zarr</span><span class="p">(</span><span class="n">ds_list</span><span class="p">,</span> <span class="n">path_list</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">,</span> <span class="n">clip_geometry</span><span class="p">,</span> <span class="n">epsg</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save input data to Zarr format.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    - ds_list (list): List of xarray.Dataset objects containing the input data.</span>
<span class="sd">    - path_list (list): List of paths where the Zarr data should be saved.</span>
<span class="sd">    - overwrite (bool): Boolean flag indicating whether to overwrite existing files.</span>
<span class="sd">    - clip_geometry (shapely.geometry.base.BaseGeometry or None): Shapely geometry used for clipping.</span>
<span class="sd">    - epsg (int): EPSG code specifying the coordinate reference system.</span>

<span class="sd">    Returns:</span>
<span class="sd">    - None</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">ds</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ds_list</span><span class="p">,</span> <span class="n">path_list</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">))</span> <span class="ow">or</span> <span class="n">overwrite</span><span class="p">:</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">coords_to_attrs</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">excluded</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
            <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;spec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;spec&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">clip_geometry</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ds</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">ds</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">write_crs</span><span class="p">(</span><span class="s2">&quot;EPSG:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epsg</span><span class="p">))</span>
                    <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float32&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">clip_box</span><span class="p">(</span>
                        <span class="n">minx</span><span class="o">=</span><span class="n">clip_geometry</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">minx</span><span class="p">,</span>
                        <span class="n">miny</span><span class="o">=</span><span class="n">clip_geometry</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">miny</span><span class="p">,</span>
                        <span class="n">maxx</span><span class="o">=</span><span class="n">clip_geometry</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">maxx</span><span class="p">,</span>
                        <span class="n">maxy</span><span class="o">=</span><span class="n">clip_geometry</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">maxy</span><span class="p">,</span>
                        <span class="n">crs</span><span class="o">=</span><span class="n">clip_geometry</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="n">ds</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="mi">1024</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="mi">1024</span><span class="p">})</span><span class="o">.</span><span class="n">to_zarr</span><span class="p">(</span>
                <span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span> <span class="k">if</span> <span class="n">overwrite</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="save_cog"><a class="viewcode-back" href="../../packages/chains.module.html#chains.module.save_cog">[docs]</a><span class="k">def</span> <span class="nf">save_cog</span><span class="p">(</span><span class="n">input_tif</span><span class="p">,</span> <span class="n">output_tif</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Saves a GeoTIFF file as a Cloud Optimized GeoTIFF (COG).</span>

<span class="sd">    Parameters:</span>
<span class="sd">        input_tif (str): The path of the input GeoTIFF file.</span>
<span class="sd">        output_tif (str): The path of the output COG file.</span>

<span class="sd">    Example usage:</span>
<span class="sd">        &gt;&gt;&gt; save_cog(&#39;input.tif&#39;, &#39;output.cog&#39;)</span>

<span class="sd">    Note:</span>
<span class="sd">        This method uses the &#39;rio cogeo create&#39; command from the &#39;rasterio&#39; library to create a Cloud Optimized GeoTIFF.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;rio cogeo create -p lzw </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">input_tif</span><span class="p">,</span> <span class="n">output_tif</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span></div>


<div class="viewcode-block" id="health_assessment"><a class="viewcode-back" href="../../packages/chains.module.html#chains.module.health_assessment">[docs]</a><span class="k">class</span> <span class="nc">health_assessment</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param start_date_pre: Start date for pre assessment</span>
<span class="sd">    :param end_date_pre: End date for pre assessment</span>
<span class="sd">    :param start_date_mid: Start date for mid assessment</span>
<span class="sd">    :param end_date_mid: End date for mid assessment</span>
<span class="sd">    :param start_date_post: Start date for post assessment</span>
<span class="sd">    :param end_date_post: End date for post assessment</span>
<span class="sd">    :param aoi: Area of interest</span>
<span class="sd">    :param clip_geometry: Clipping geometry</span>
<span class="sd">    :param mgrs_tile: MGRS tile</span>
<span class="sd">    :param epsg: EPSG code</span>
<span class="sd">    :param cloudcover: Maximum cloud cover threshold</span>
<span class="sd">    :param save_to_disk: Saving options</span>
<span class="sd">    :param results_path: Path to store the assessment results</span>
<span class="sd">    :param aoi_name: Name of the Area of Interest</span>
<span class="sd">    :param assessment_kind: Kind of assessment (weekly or yearly)</span>
<span class="sd">    :param chain: Classification chain</span>
<span class="sd">    :param fn_path: File path for forest non-forest classifier</span>
<span class="sd">    :param ft_path: File path for Feature Transform model</span>
<span class="sd">    :param ft_cod_path: File path for Feature Transform dictionary</span>
<span class="sd">    :param th: Threshold value for classification</span>
<span class="sd">    :param mmu: Minimum Mapping Unit (MMU)</span>
<span class="sd">    :param overwrite: Overwrite existing results if True</span>
<span class="sd">    :param log_level: Logging level (debug, info, warning, error, critical)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">start_date_pre</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">,</span>
        <span class="n">end_date_pre</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">,</span>
        <span class="n">start_date_mid</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">,</span>
        <span class="n">end_date_mid</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">,</span>
        <span class="n">start_date_post</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">,</span>
        <span class="n">end_date_post</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">,</span>
        <span class="n">aoi</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">clip_geometry</span><span class="p">,</span>
        <span class="n">mgrs_tile</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">epsg</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">cloudcover</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">save_to_disk</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">results_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">aoi_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">assessment_kind</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">chain</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">fn_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">ft_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">ft_cod_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">th</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">224</span><span class="p">,</span>
        <span class="n">mmu</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">log_level</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;warning&quot;</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_date_pre</span> <span class="o">=</span> <span class="n">start_date_pre</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_date_pre</span> <span class="o">=</span> <span class="n">end_date_pre</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_date_mid</span> <span class="o">=</span> <span class="n">start_date_mid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_date_mid</span> <span class="o">=</span> <span class="n">end_date_mid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_date_post</span> <span class="o">=</span> <span class="n">start_date_post</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_date_post</span> <span class="o">=</span> <span class="n">end_date_post</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aoi</span> <span class="o">=</span> <span class="n">aoi</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clip_geometry</span> <span class="o">=</span> <span class="n">clip_geometry</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mgrs_tile</span> <span class="o">=</span> <span class="n">mgrs_tile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stac_epsg</span> <span class="o">=</span> <span class="mi">32632</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epsg</span> <span class="o">=</span> <span class="n">epsg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cloudcover</span> <span class="o">=</span> <span class="n">cloudcover</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_to_disk</span> <span class="o">=</span> <span class="n">save_to_disk</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results_path</span> <span class="o">=</span> <span class="n">results_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aoi_name</span> <span class="o">=</span> <span class="n">aoi_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assessment_kind</span> <span class="o">=</span> <span class="n">assessment_kind</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chain</span> <span class="o">=</span> <span class="n">chain</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fn_path</span> <span class="o">=</span> <span class="n">fn_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ft_path</span> <span class="o">=</span> <span class="n">ft_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ft_cod_path</span> <span class="o">=</span> <span class="n">ft_cod_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">overwrite</span> <span class="o">=</span> <span class="n">overwrite</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="n">log_level</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">initialize_logger</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">log_level</span> <span class="o">==</span> <span class="s2">&quot;debug&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">log_level</span> <span class="o">==</span> <span class="s2">&quot;info&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">log_level</span> <span class="o">==</span> <span class="s2">&quot;warning&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">log_level</span> <span class="o">==</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">log_level</span> <span class="o">==</span> <span class="s2">&quot;critical&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">)</span>

        <span class="c1"># collection to query</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collections</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;sentinel-2-l2a&quot;</span><span class="p">]</span>

        <span class="c1"># query to select a cloud cover threshold and a specific tile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;eo:cloud_cover&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;lt&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cloudcover</span><span class="p">},</span>
            <span class="s2">&quot;s2:mgrs_tile&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;in&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mgrs_tile</span><span class="p">},</span>
        <span class="p">}</span>

        <span class="c1"># bands of interest</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assets</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;B02&quot;</span><span class="p">,</span>
            <span class="s2">&quot;B03&quot;</span><span class="p">,</span>
            <span class="s2">&quot;B04&quot;</span><span class="p">,</span>
            <span class="s2">&quot;B05&quot;</span><span class="p">,</span>
            <span class="s2">&quot;B06&quot;</span><span class="p">,</span>
            <span class="s2">&quot;B07&quot;</span><span class="p">,</span>
            <span class="s2">&quot;B08&quot;</span><span class="p">,</span>
            <span class="s2">&quot;B8A&quot;</span><span class="p">,</span>
            <span class="s2">&quot;B09&quot;</span><span class="p">,</span>
            <span class="s2">&quot;B11&quot;</span><span class="p">,</span>
            <span class="s2">&quot;B12&quot;</span><span class="p">,</span>
            <span class="s2">&quot;SCL&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="c1"># spatial resolution (meters)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="c1"># nodata value for Sentinel-2 L2A</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodata</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># save flags</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_input_dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_to_disk</span><span class="p">[</span><span class="s2">&quot;save_input_dataset&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_medoid_pre</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_to_disk</span><span class="p">[</span><span class="s2">&quot;save_medoid_pre&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_medoid_post</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_to_disk</span><span class="p">[</span><span class="s2">&quot;save_medoid_post&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_indexes_pre</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_to_disk</span><span class="p">[</span><span class="s2">&quot;save_indexes_pre&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_indexes_post</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_to_disk</span><span class="p">[</span><span class="s2">&quot;save_indexes_post&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_classification</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_to_disk</span><span class="p">[</span><span class="s2">&quot;save_classification&quot;</span><span class="p">]</span>

        <span class="c1"># data directories</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results_path</span><span class="p">,</span> <span class="s2">&quot;input&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temporary_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results_path</span><span class="p">,</span> <span class="s2">&quot;temp&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results_path</span><span class="p">,</span> <span class="s2">&quot;output&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fhm_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">&quot;FHM&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fcm_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">&quot;FCM&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fv_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">&quot;FV&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fhm_dir_cog</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">&quot;FHM&quot;</span><span class="p">,</span> <span class="s2">&quot;COG&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fcm_dir_cog</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">&quot;FCM&quot;</span><span class="p">,</span> <span class="s2">&quot;COG&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fv_dir_cog</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">&quot;FV&quot;</span><span class="p">,</span> <span class="s2">&quot;COG&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">magnitude_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temporary_dir</span><span class="p">,</span> <span class="s2">&quot;magnitude&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sentinel_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temporary_dir</span><span class="p">,</span> <span class="s2">&quot;sentinel_input&quot;</span><span class="p">)</span>

        <span class="c1"># time range for the queries</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_range_pre</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_date_pre</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;/&quot;</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_date_pre</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_range_post</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_date_post</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;/&quot;</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_date_post</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Pre time range: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_range_pre</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Post time range: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_range_post</span><span class="p">))</span>

        <span class="c1"># defines products names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">svc_number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;SVC&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">svc_letter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;SVC&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">svc_number</span> <span class="o">==</span> <span class="s2">&quot;10&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">assessment_kind</span> <span class="o">==</span> <span class="s2">&quot;weekly&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">product_number</span> <span class="o">=</span> <span class="s2">&quot;01&quot;</span>
        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">svc_number</span> <span class="o">==</span> <span class="s2">&quot;10&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">assessment_kind</span> <span class="o">==</span> <span class="s2">&quot;yearly&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">svc_number</span> <span class="o">==</span> <span class="s2">&quot;07&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">svc_letter</span> <span class="o">==</span> <span class="s2">&quot;B&quot;</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">product_number</span> <span class="o">=</span> <span class="s2">&quot;02&quot;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">svc_number</span> <span class="o">==</span> <span class="s2">&quot;07&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">svc_letter</span> <span class="o">==</span> <span class="s2">&quot;C&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">product_number</span> <span class="o">=</span> <span class="s2">&quot;03&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">product_id</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;OU-S4&quot;</span> <span class="o">+</span> <span class="s2">&quot;-</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">svc_number</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;-</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">product_number</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">start_date_pre_filename</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_date_pre</span><span class="o">.</span><span class="n">date</span><span class="p">())</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_date_pre_filename</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end_date_pre</span><span class="o">.</span><span class="n">date</span><span class="p">())</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_date_post_filename</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_date_post</span><span class="o">.</span><span class="n">date</span><span class="p">())</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_date_post_filename</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end_date_post</span><span class="o">.</span><span class="n">date</span><span class="p">())</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sentinel_pre_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sentinel_dir</span><span class="p">,</span>
            <span class="s2">&quot;ds_</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">.zarr&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">aoi_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_range_pre</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sentinel_post_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sentinel_dir</span><span class="p">,</span>
            <span class="s2">&quot;ds_</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">.zarr&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">aoi_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_range_post</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">medoid_pre_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input_dir</span><span class="p">,</span>
            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">_pre_medoid.tif&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">aoi_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_date_pre_filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_date_pre_filename</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">medoid_post_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input_dir</span><span class="p">,</span>
            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">_post_medoid.tif&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">aoi_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_date_post_filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_date_post_filename</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ndmi_pre_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input_dir</span><span class="p">,</span>
            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">_pre_ndmi.tif&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">aoi_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_date_pre_filename</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nbr_pre_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input_dir</span><span class="p">,</span>
            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">_pre_nbr.tif&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">aoi_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_date_pre_filename</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msi_pre_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input_dir</span><span class="p">,</span>
            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">_pre_msi.tif&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">aoi_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_date_pre_filename</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ndmi_post_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input_dir</span><span class="p">,</span>
            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">_post_ndmi.tif&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">aoi_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_date_post_filename</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nbr_post_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input_dir</span><span class="p">,</span>
            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">_post_nbr.tif&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">aoi_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_date_post_filename</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msi_post_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input_dir</span><span class="p">,</span>
            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">_post_msi.tif&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">aoi_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_date_post_filename</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">assessment_kind</span> <span class="o">==</span> <span class="s2">&quot;weekly&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_date_pre_filename</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_date_pre</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=+</span><span class="mi">14</span><span class="p">))</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
            <span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">end_date_post_filename</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_date_pre</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=+</span><span class="mi">21</span><span class="p">))</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
            <span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">magnitude_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">magnitude_dir</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">product_id</span>
            <span class="o">+</span> <span class="s2">&quot;_Magnitude&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;_1</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">assessment_kind</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="o">+</span> <span class="s2">&quot;_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">aoi_name</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;_</span><span class="si">{}</span><span class="s2">T000000&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_date_pre_filename</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;_</span><span class="si">{}</span><span class="s2">T000000&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end_date_post_filename</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;.tif&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">classes_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fhm_dir</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">product_id</span>
            <span class="o">+</span> <span class="s2">&quot;_ForestHealthMap&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;_1</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">assessment_kind</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="o">+</span> <span class="s2">&quot;_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">aoi_name</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;_</span><span class="si">{}</span><span class="s2">T000000&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_date_pre_filename</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;_</span><span class="si">{}</span><span class="s2">T000000&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end_date_post_filename</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;.tif&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">classes_filename_cog</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fhm_dir_cog</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">product_id</span>
            <span class="o">+</span> <span class="s2">&quot;_ForestHealthMap&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;_1</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">assessment_kind</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="o">+</span> <span class="s2">&quot;_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">aoi_name</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;_</span><span class="si">{}</span><span class="s2">T000000&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_date_pre_filename</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;_</span><span class="si">{}</span><span class="s2">T000000&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end_date_post_filename</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;.tif&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">vulnerability_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fv_dir</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">product_id</span>
            <span class="o">+</span> <span class="s2">&quot;_ForestVulnerabilityMap&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;_1</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">assessment_kind</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="o">+</span> <span class="s2">&quot;_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">aoi_name</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;_</span><span class="si">{}</span><span class="s2">T000000&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_date_pre_filename</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;_</span><span class="si">{}</span><span class="s2">T000000&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end_date_post_filename</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;.tif&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">vulnerability_filename_cog</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fv_dir_cog</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">product_id</span>
            <span class="o">+</span> <span class="s2">&quot;_ForestVulnerabilityMap&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;_1</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">assessment_kind</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="o">+</span> <span class="s2">&quot;_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">aoi_name</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;_</span><span class="si">{}</span><span class="s2">T000000&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_date_pre_filename</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;_</span><span class="si">{}</span><span class="s2">T000000&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end_date_post_filename</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;.tif&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">time_ranges</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_range_pre</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_range_post</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sentinel_path_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sentinel_pre_filename</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sentinel_post_filename</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_dates</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">start_date_pre</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_date_post</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_dates</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">end_date_pre</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_date_post</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">medoid_paths</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">medoid_pre_filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">medoid_post_filename</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">medoid_flags</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">save_medoid_pre</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_medoid_post</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indexes_pre_filename</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ndmi_pre_filename</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nbr_pre_filename</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msi_pre_filename</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indexes_post_filename</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ndmi_post_filename</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nbr_post_filename</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msi_post_filename</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index_paths</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">indexes_pre_filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">indexes_post_filename</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index_flags</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">save_indexes_pre</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_indexes_post</span><span class="p">]</span>

        <span class="c1"># in the case of SVC07B also third image and additional operations are needed</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain</span> <span class="o">==</span> <span class="s2">&quot;SVC07B&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">th</span> <span class="o">=</span> <span class="n">th</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mmu</span> <span class="o">=</span> <span class="n">mmu</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time_range_mid</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">start_date_mid</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="o">+</span> <span class="s2">&quot;/&quot;</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_date_mid</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Mid time range: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_range_mid</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_medoid_mid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_to_disk</span><span class="p">[</span><span class="s2">&quot;save_medoid_mid&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_indexes_mid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_to_disk</span><span class="p">[</span><span class="s2">&quot;save_indexes_mid&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_date_mid_filename</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_date_mid</span><span class="o">.</span><span class="n">date</span><span class="p">())</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">end_date_mid_filename</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end_date_mid</span><span class="o">.</span><span class="n">date</span><span class="p">())</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sentinel_mid_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sentinel_dir</span><span class="p">,</span>
                <span class="s2">&quot;ds_</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">.zarr&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">aoi_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_range_mid</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">medoid_mid_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">input_dir</span><span class="p">,</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">_mid_medoid.tif&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">aoi_name</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">start_date_mid_filename</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">end_date_mid_filename</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ndmi_mid_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">input_dir</span><span class="p">,</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">_mid_ndmi.tif&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">aoi_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_date_mid_filename</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nbr_mid_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">input_dir</span><span class="p">,</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">_mid_nbr.tif&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">aoi_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_date_mid_filename</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msi_mid_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">input_dir</span><span class="p">,</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">_mid_msi.tif&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">aoi_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_date_mid_filename</span><span class="p">),</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">time_ranges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_ranges</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_range_mid</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sentinel_path_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sentinel_path_list</span> <span class="o">+</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sentinel_mid_filename</span>
            <span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_dates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_dates</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">start_date_mid</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">end_dates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_dates</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">end_date_mid</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">medoid_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">medoid_paths</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">medoid_mid_filename</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">medoid_flags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">medoid_flags</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">save_medoid_mid</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indexes_mid_filename</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ndmi_mid_filename</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nbr_mid_filename</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msi_mid_filename</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">index_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_paths</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">indexes_mid_filename</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">index_flags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_flags</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">save_indexes_mid</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">change_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fcm_dir</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">product_id</span>
                <span class="o">+</span> <span class="s2">&quot;_ForestChangeMap&quot;</span>
                <span class="o">+</span> <span class="s2">&quot;_1</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">assessment_kind</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="o">+</span> <span class="s2">&quot;_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">aoi_name</span><span class="p">)</span>
                <span class="o">+</span> <span class="s2">&quot;_</span><span class="si">{}</span><span class="s2">T000000&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_date_mid_filename</span><span class="p">)</span>
                <span class="o">+</span> <span class="s2">&quot;_</span><span class="si">{}</span><span class="s2">T000000&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end_date_mid_filename</span><span class="p">)</span>
                <span class="o">+</span> <span class="s2">&quot;.tif&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">change_filename_cog</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fcm_dir_cog</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">product_id</span>
                <span class="o">+</span> <span class="s2">&quot;_ForestChangeMap&quot;</span>
                <span class="o">+</span> <span class="s2">&quot;_1</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">assessment_kind</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="o">+</span> <span class="s2">&quot;_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">aoi_name</span><span class="p">)</span>
                <span class="o">+</span> <span class="s2">&quot;_</span><span class="si">{}</span><span class="s2">T000000&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_date_mid_filename</span><span class="p">)</span>
                <span class="o">+</span> <span class="s2">&quot;_</span><span class="si">{}</span><span class="s2">T000000&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end_date_mid_filename</span><span class="p">)</span>
                <span class="o">+</span> <span class="s2">&quot;.tif&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># flag that allows to skip time ranges that have already been completed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skip_timerange</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chain</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;SVC07C&quot;</span><span class="p">,</span> <span class="s2">&quot;SVC10C&quot;</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">assessment_kind</span> <span class="o">==</span> <span class="s2">&quot;yearly&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vulnerability_filename</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">skip_timerange</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain</span> <span class="o">==</span> <span class="s2">&quot;SVC07B&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">change_filename</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">skip_timerange</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">classes_filename</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">skip_timerange</span> <span class="o">=</span> <span class="kc">True</span>

<div class="viewcode-block" id="health_assessment.create_directories"><a class="viewcode-back" href="../../packages/chains.module.html#chains.module.health_assessment.create_directories">[docs]</a>    <span class="k">def</span> <span class="nf">create_directories</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method: create_directories</span>

<span class="sd">        This method creates directories for different purposes based on the provided parameters. It ensures that the directories are created if they don&#39;t already exist.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        - self: The object instance itself.</span>

<span class="sd">        Returns:</span>
<span class="sd">        - None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temporary_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;SVC07B&quot;</span><span class="p">]:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fcm_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fcm_dir_cog</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;SVC07C&quot;</span><span class="p">,</span> <span class="s2">&quot;SVC10C&quot;</span><span class="p">]:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhm_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhm_dir_cog</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">assessment_kind</span> <span class="o">==</span> <span class="s2">&quot;yearly&quot;</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fv_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fv_dir_cog</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">magnitude_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sentinel_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="health_assessment.prepare_input_datsets"><a class="viewcode-back" href="../../packages/chains.module.html#chains.module.health_assessment.prepare_input_datsets">[docs]</a>    <span class="nd">@retry</span><span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="n">tries</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="nd">@timed</span>
    <span class="k">def</span> <span class="nf">prepare_input_datsets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepares Sentinel 2 Level 2A datasets.</span>

<span class="sd">        Retry decorator is applied to handle possible runtime errors and retry the method execution up to 10 times with a delay of 2 seconds between each attempt.</span>
<span class="sd">        Timed decorator is applied to measure the execution time of the method.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            self (object): The current instance of the class.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: A list of xarray datasets representing the prepared Sentinel 2 Level 2A datasets.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Preparing Sentinel 2 L2A datasets.&quot;</span><span class="p">)</span>
        <span class="n">ds_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># queries sentinel data from Microsoft Planetary</span>
        <span class="k">for</span> <span class="n">time_range</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_ranges</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sentinel_path_list</span><span class="p">):</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">stac_to_dataset</span><span class="p">(</span>
                <span class="n">aoi</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">aoi</span><span class="p">,</span>
                <span class="n">time_range</span><span class="o">=</span><span class="n">time_range</span><span class="p">,</span>
                <span class="n">collections</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">collections</span><span class="p">,</span>
                <span class="n">query</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">,</span>
                <span class="n">assets</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">assets</span><span class="p">,</span>
                <span class="n">epsg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stac_epsg</span><span class="p">,</span>
                <span class="n">resolution</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">resolution</span><span class="p">,</span>
                <span class="n">nodata</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nodata</span><span class="p">,</span>
            <span class="p">)</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;&quot;&quot;</span>
<span class="sd">            epsg = ds.rio.crs.to_string()</span>
<span class="sd">            self.clip_geometry = self.clip_geometry.to_crs(epsg)</span>
<span class="sd">            ds = ds.rio.write_crs(epsg).astype(&#39;float32&#39;).rio.clip_box(minx=self.clip_geometry.bounds.minx,</span>
<span class="sd">                                            miny=self.clip_geometry.bounds.miny,</span>
<span class="sd">                                            maxx=self.clip_geometry.bounds.maxx,</span>
<span class="sd">                                            maxy=self.clip_geometry.bounds.maxy,</span>
<span class="sd">                                            crs=self.clip_geometry.crs)</span>
<span class="sd">            for i, time in enumerate(ds.time.values[:6]):</span>
<span class="sd">                id = ds[&#39;id&#39;].values[i]</span>
<span class="sd">                tif_path = os.path.join(self.sentinel_dir, &#39;{}_pre_mask.tif&#39;.format(id))</span>
<span class="sd">                ds.isel(time=i).to_array(&#39;band&#39;).rio.to_raster(tif_path)</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1"># saving the input dataset and reading it from disk is more stable for dask delayed computations</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_input_dataset</span><span class="p">:</span>
                <span class="n">save_input_zarr</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">ds</span><span class="p">],</span> <span class="p">[</span><span class="n">path</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">overwrite</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">clip_geometry</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stac_epsg</span>
                <span class="p">)</span>

            <span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_zarr</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;Dataset dimensions: time, x, y = </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">time</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">x</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">ds_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ds_list</span></div>

<div class="viewcode-block" id="health_assessment.baseline_adjustment"><a class="viewcode-back" href="../../packages/chains.module.html#chains.module.health_assessment.baseline_adjustment">[docs]</a>    <span class="k">def</span> <span class="nf">baseline_adjustment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds_list</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adjusts the baseline of the dataset list based on a specified cutoff date.</span>

<span class="sd">        :param ds_list: A list of datasets.</span>
<span class="sd">        :type ds_list: list</span>
<span class="sd">        :return: A list of datasets with the baseline adjusted.</span>
<span class="sd">        :rtype: list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Adjusting baseline.&quot;</span><span class="p">)</span>
        <span class="c1"># adjustment for sentinel 2 baseline change</span>
        <span class="n">cutoff</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2022</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>

        <span class="n">ds_list_harmonized</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ds</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ds_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_dates</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_dates</span><span class="p">):</span>
            <span class="n">start_before_cutoff</span> <span class="o">=</span> <span class="n">start_date</span> <span class="o">&lt;=</span> <span class="n">cutoff</span>
            <span class="n">start_after_cutoff</span> <span class="o">=</span> <span class="n">start_date</span> <span class="o">&gt;</span> <span class="n">cutoff</span>
            <span class="n">end_before_cutoff</span> <span class="o">=</span> <span class="n">end_date</span> <span class="o">&lt;=</span> <span class="n">cutoff</span>
            <span class="n">end_after_cutoff</span> <span class="o">=</span> <span class="n">end_date</span> <span class="o">&gt;</span> <span class="n">cutoff</span>

            <span class="k">if</span> <span class="n">start_after_cutoff</span> <span class="ow">or</span> <span class="p">(</span><span class="n">start_before_cutoff</span> <span class="ow">and</span> <span class="n">end_after_cutoff</span><span class="p">):</span>
                <span class="n">ds_harmonized</span> <span class="o">=</span> <span class="n">harmonize_to_old</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ds_harmonized</span> <span class="o">=</span> <span class="n">ds</span>
            <span class="n">ds_list_harmonized</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ds_harmonized</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ds_list_harmonized</span></div>

<div class="viewcode-block" id="health_assessment.mask_datasets"><a class="viewcode-back" href="../../packages/chains.module.html#chains.module.health_assessment.mask_datasets">[docs]</a>    <span class="k">def</span> <span class="nf">mask_datasets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds_list</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Masks the datasets in the given list.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        - ds_list: A list of xarray Dataset objects. Each Dataset represents a dataset to be masked.</span>

<span class="sd">        Returns:</span>
<span class="sd">        - ds_list_masked: A list of masked xarray Dataset objects. Each Dataset in the list has been masked.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Masking datasets.&quot;</span><span class="p">)</span>
        <span class="c1"># masks the datasets</span>
        <span class="n">ds_list_masked</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">ds_list</span><span class="p">:</span>
            <span class="n">ds_masked</span> <span class="o">=</span> <span class="n">s2l2a_masked</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s2">&quot;SCL&quot;</span><span class="p">)</span>
            <span class="n">ds_list_masked</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ds_masked</span><span class="p">)</span>
            <span class="n">epsg</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clip_geometry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clip_geometry</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">epsg</span><span class="p">)</span>
            <span class="n">ds_masked</span> <span class="o">=</span> <span class="n">ds_masked</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float32&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">clip_box</span><span class="p">(</span>
                <span class="n">minx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clip_geometry</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">minx</span><span class="p">,</span>
                <span class="n">miny</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clip_geometry</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">miny</span><span class="p">,</span>
                <span class="n">maxx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clip_geometry</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">maxx</span><span class="p">,</span>
                <span class="n">maxy</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clip_geometry</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">maxy</span><span class="p">,</span>
                <span class="n">crs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clip_geometry</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span>
            <span class="p">)</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            for i, time in enumerate(ds_masked.time.values[:6]):</span>
<span class="sd">                id = ds_masked[&#39;id&#39;].values[i]</span>
<span class="sd">                tif_path = os.path.join(self.sentinel_dir, &#39;{}_post_mask.tif&#39;.format(id))</span>
<span class="sd">                ds_masked.isel(time=i).to_array(&#39;band&#39;).rio.to_raster(tif_path)</span>
<span class="sd">            &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">ds_list_masked</span></div>

<div class="viewcode-block" id="health_assessment.compute_medoids"><a class="viewcode-back" href="../../packages/chains.module.html#chains.module.health_assessment.compute_medoids">[docs]</a>    <span class="nd">@retry</span><span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="n">tries</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="nd">@timed</span>
    <span class="k">def</span> <span class="nf">compute_medoids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds_list</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method computes the medoids for a given list of datasets.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        - ds_list: list of xarray.Dataset objects. Each dataset represents a time series of raster data.</span>

<span class="sd">        Returns:</span>
<span class="sd">        - ds_list_medoid: list of xarray.Dataset objects. Each dataset represents the computed medoid for the corresponding input dataset.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Computing medoids.&quot;</span><span class="p">)</span>
        <span class="c1"># computes the medoids</span>
        <span class="n">ds_list_medoid</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ds</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">flag</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ds_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">medoid_paths</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">medoid_flags</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">))</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">overwrite</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;Computing medoid of times: </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">ds_medoid</span> <span class="o">=</span> <span class="n">medoid_mosaic</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
                    <span class="n">ds_medoid</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">write_crs</span><span class="p">(</span>
                        <span class="s2">&quot;EPSG:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stac_epsg</span><span class="p">)</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">to_raster</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ds_medoid</span> <span class="o">=</span> <span class="n">rio</span><span class="o">.</span><span class="n">open_rasterio</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">ds_list_medoid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ds_medoid</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ds_list_medoid</span></div>

<div class="viewcode-block" id="health_assessment.compute_indexes"><a class="viewcode-back" href="../../packages/chains.module.html#chains.module.health_assessment.compute_indexes">[docs]</a>    <span class="nd">@retry</span><span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="n">tries</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="nd">@timed</span>
    <span class="k">def</span> <span class="nf">compute_indexes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds_list</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes and saves the indexes for each dataset in ds_list.</span>

<span class="sd">        The method calculates the Normalized Difference Moisture Index (NDMI),</span>
<span class="sd">        Normalized Burn Ratio (NBR), and Multispectral Similarity Index (MSI)</span>
<span class="sd">        for each dataset in ds_list. The indexes are then saved to the specified</span>
<span class="sd">        paths.</span>

<span class="sd">        Args:</span>
<span class="sd">            ds_list (list): A list of datasets.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: A list containing the computed indexes.</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If the computation of indexes fails.</span>
<span class="sd">            RetryError: If the computation of indexes fails after multiple retries.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Computing indexes.&quot;</span><span class="p">)</span>
        <span class="c1"># calculates and saves the indexes</span>
        <span class="n">ds_list_index</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">flag</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ds_list</span><span class="p">)),</span> <span class="n">ds_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_flags</span><span class="p">):</span>
            <span class="n">ndmi</span><span class="p">,</span> <span class="n">nbr</span><span class="p">,</span> <span class="n">msi</span> <span class="o">=</span> <span class="n">calculate_ndmi_nbr_msi</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
            <span class="n">ds_list_index</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ndmi</span><span class="p">)</span>
            <span class="n">ds_list_index</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nbr</span><span class="p">)</span>
            <span class="n">ds_list_index</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msi</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">ndmi</span><span class="p">,</span> <span class="n">nbr</span><span class="p">,</span> <span class="n">msi</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_paths</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
                    <span class="n">index</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">write_crs</span><span class="p">(</span><span class="s2">&quot;EPSG:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stac_epsg</span><span class="p">))</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">to_raster</span><span class="p">(</span>
                        <span class="n">path</span>
                    <span class="p">)</span>
        <span class="k">return</span> <span class="n">ds_list_index</span></div>

<div class="viewcode-block" id="health_assessment.compute_assessment"><a class="viewcode-back" href="../../packages/chains.module.html#chains.module.health_assessment.compute_assessment">[docs]</a>    <span class="nd">@retry</span><span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="n">tries</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="nd">@timed</span>
    <span class="k">def</span> <span class="nf">compute_assessment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method is the entry point for computing the assessment of&quot;&quot;&quot;</span>
        <span class="c1"># skips time ranges that have already been completed</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_timerange</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Skipping time range.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">create_directories</span><span class="p">()</span>
        <span class="n">ds_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_input_datsets</span><span class="p">()</span>
        <span class="n">ds_list_masked</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_datasets</span><span class="p">(</span><span class="n">ds_list</span><span class="p">)</span>
        <span class="n">ds_list_harmonized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline_adjustment</span><span class="p">(</span><span class="n">ds_list_masked</span><span class="p">)</span>
        <span class="n">ds_list_medoid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_medoids</span><span class="p">(</span><span class="n">ds_list_harmonized</span><span class="p">)</span>

        <span class="c1"># conversion to xarray dataset if needed</span>
        <span class="n">ds_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">ds_list_medoid</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">):</span>
                <span class="n">ds</span> <span class="o">=</span> <span class="n">datarray2dataset</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
                <span class="n">ds_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ds_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>

        <span class="n">ds_list_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_indexes</span><span class="p">(</span><span class="n">ds_list</span><span class="p">)</span>

        <span class="c1"># computes the change magnitude</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Computing change magnitude.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain</span> <span class="o">==</span> <span class="s2">&quot;SVC07B&quot;</span><span class="p">:</span>
            <span class="p">(</span>
                <span class="n">ndmi_pre</span><span class="p">,</span>
                <span class="n">nbr_pre</span><span class="p">,</span>
                <span class="n">msi_pre</span><span class="p">,</span>
                <span class="n">ndmi_post</span><span class="p">,</span>
                <span class="n">nbr_post</span><span class="p">,</span>
                <span class="n">msi_post</span><span class="p">,</span>
                <span class="n">ndmi_mid</span><span class="p">,</span>
                <span class="n">nbr_mid</span><span class="p">,</span>
                <span class="n">msi_mid</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="n">ds_list_index</span>
            <span class="n">magnitude</span> <span class="o">=</span> <span class="n">calculate_magnitude_trio</span><span class="p">(</span>
                <span class="n">ndmi_pre</span><span class="p">,</span>
                <span class="n">nbr_pre</span><span class="p">,</span>
                <span class="n">msi_pre</span><span class="p">,</span>
                <span class="n">ndmi_mid</span><span class="p">,</span>
                <span class="n">nbr_mid</span><span class="p">,</span>
                <span class="n">msi_mid</span><span class="p">,</span>
                <span class="n">ndmi_post</span><span class="p">,</span>
                <span class="n">nbr_post</span><span class="p">,</span>
                <span class="n">msi_post</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># classifies the change magnitude</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Classifying the change magnitude.&quot;</span><span class="p">)</span>
            <span class="n">change</span> <span class="o">=</span> <span class="n">compute_change</span><span class="p">(</span>
                <span class="n">magnitude</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">th</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fn_path</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">change_filename</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">change_filename_cog</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stac_epsg</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">epsg</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">save_classification</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">clip_geometry</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">overwrite</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mmu</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ndmi_pre</span><span class="p">,</span> <span class="n">nbr_pre</span><span class="p">,</span> <span class="n">msi_pre</span><span class="p">,</span> <span class="n">ndmi_post</span><span class="p">,</span> <span class="n">nbr_post</span><span class="p">,</span> <span class="n">msi_post</span> <span class="o">=</span> <span class="n">ds_list_index</span>
            <span class="n">magnitude</span> <span class="o">=</span> <span class="n">calculate_magnitude</span><span class="p">(</span>
                <span class="n">ndmi_pre</span><span class="p">,</span> <span class="n">nbr_pre</span><span class="p">,</span> <span class="n">msi_pre</span><span class="p">,</span> <span class="n">ndmi_post</span><span class="p">,</span> <span class="n">nbr_post</span><span class="p">,</span> <span class="n">msi_post</span>
            <span class="p">)</span>

            <span class="c1"># classifies the change magnitude</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Classifying the change magnitude.&quot;</span><span class="p">)</span>
            <span class="n">classes</span> <span class="o">=</span> <span class="n">compute_classification</span><span class="p">(</span>
                <span class="n">magnitude</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fn_path</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">classes_filename</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">classes_filename_cog</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stac_epsg</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">epsg</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">save_classification</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">clip_geometry</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">overwrite</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># computes the vulnerability map</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Computing the vulnerability map.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chain</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;SVC07C&quot;</span><span class="p">,</span> <span class="s2">&quot;SVC10C&quot;</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assessment_kind</span> <span class="o">==</span> <span class="s2">&quot;yearly&quot;</span>
            <span class="p">):</span>
                <span class="n">compute_vulnerability</span><span class="p">(</span>
                    <span class="n">classes</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ft_path</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ft_cod_path</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">vulnerability_filename</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">vulnerability_filename_cog</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">epsg</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">save_classification</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">clip_geometry</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">overwrite</span><span class="p">,</span>
                <span class="p">)</span></div></div>


<div class="viewcode-block" id="get_config"><a class="viewcode-back" href="../../packages/chains.module.html#chains.module.get_config">[docs]</a><span class="k">def</span> <span class="nf">get_config</span><span class="p">(</span><span class="n">config_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;config.ini&quot;</span><span class="p">):</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>
    <span class="n">path_current_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
    <span class="n">path_config_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_current_directory</span><span class="p">,</span> <span class="n">config_file</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">path_config_file</span><span class="p">)</span>

    <span class="n">config_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;COMMON&quot;</span><span class="p">])</span>

    <span class="n">chain</span> <span class="o">=</span> <span class="n">config_dict</span><span class="p">[</span><span class="s2">&quot;chain&quot;</span><span class="p">]</span>
    <span class="n">assessment_kind</span> <span class="o">=</span> <span class="n">config_dict</span><span class="p">[</span><span class="s2">&quot;assessment_kind&quot;</span><span class="p">]</span>
    <span class="n">aoi</span> <span class="o">=</span> <span class="n">config_dict</span><span class="p">[</span><span class="s2">&quot;aoi&quot;</span><span class="p">]</span>

    <span class="k">assert</span> <span class="n">chain</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;SVC10C&quot;</span><span class="p">,</span> <span class="s2">&quot;SVC07B&quot;</span><span class="p">,</span> <span class="s2">&quot;SVC07C&quot;</span><span class="p">],</span> <span class="n">chain</span>
    <span class="k">assert</span> <span class="n">aoi</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;AOI1&quot;</span><span class="p">,</span> <span class="s2">&quot;AOI2&quot;</span><span class="p">,</span> <span class="s2">&quot;AOI3&quot;</span><span class="p">],</span> <span class="n">aoi</span>
    <span class="k">if</span> <span class="n">chain</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;SVC07B&quot;</span><span class="p">,</span> <span class="s2">&quot;SVC07C&quot;</span><span class="p">]:</span>
        <span class="k">assert</span> <span class="n">assessment_kind</span> <span class="o">==</span> <span class="s2">&quot;yearly&quot;</span><span class="p">,</span> <span class="n">assessment_kind</span>
    <span class="k">elif</span> <span class="n">chain</span> <span class="o">==</span> <span class="s2">&quot;SVC10C&quot;</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">assessment_kind</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;weekly&quot;</span><span class="p">,</span> <span class="s2">&quot;yearly&quot;</span><span class="p">],</span> <span class="n">assessment_kind</span>

    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">dict</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="n">chain</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">assessment_kind</span><span class="p">])</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">config_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

    <span class="k">return</span> <span class="n">config_dict</span></div>
</pre></div>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By GMATICS srl
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
       Copyright 2024, GMATICS srl.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=5b4479735964841361fd"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>